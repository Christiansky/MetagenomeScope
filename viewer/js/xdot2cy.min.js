/* Copyright (C) 2017-2018 Marcus Fedarko, Jay Ghurye, Todd Treangen, Mihai Pop
 * Authored by Marcus Fedarko
 *
 * This file is part of MetagenomeScope.
 *
 * MetagenomeScope is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * MetagenomeScope is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with MetagenomeScope.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";var BLOB_SIZE=1048576;var FRAYED_ROPE_LEFTRIGHTDIR="-1 -1 0 -0.5 1 -1 1 1 0 0.5 -1 1";var FRAYED_ROPE_UPDOWNDIR="1 -1 0.5 0 1 1 -1 1 -0.5 0 -1 -1";var BUBBLE_LEFTRIGHTDIR="-1 0 -0.5 -1 0.5 -1 1 0 0.5 1 -0.5 1";var BUBBLE_UPDOWNDIR="-1 -0.5 0 -1 1 -0.5 1 0.5 0 1 -1 0.5";var NODE_LEFTDIR="1 1 -0.23587 1 -1 0 -0.23587 -1 1 -1";var NODE_RIGHTDIR="-1 1 0.23587 1 1 0 0.23587 -1 -1 -1";var NODE_UPDIR="-1 1 -1 -0.23587 0 -1 1 -0.23587 1 1";var NODE_DOWNDIR="-1 -1 -1 0.23587 0 1 1 0.23587 1 -1";var SQUARE_COORDS="-1 -1 -1 1 1 1 1 -1";var INCHES_TO_PIXELS=54;var CTRL_PT_DIST_EPSILON=1;var MAX_EDGE_THICKNESS=10;var MIN_EDGE_THICKNESS=3;var EDGE_THICKNESS_RANGE=MAX_EDGE_THICKNESS-MIN_EDGE_THICKNESS;var CURR_VIEWTYPE;var CURR_SPQRMODE;var BICOMPONENTID2VISIBLESINGLENODEIDS={};var CURR_BOUNDINGBOX;var PREV_ROTATION;var CURR_ROTATION;var CURR_NODE_COLORIZATION=null;var MAX_RGB=undefined;var MIN_RGB=undefined;var MAX_HEX=undefined;var MIN_HEX=undefined;var DEFAULT_NODE_COLOR=undefined;var DEFAULT_COLOR_SETTINGS="mincncp\t#0022ff\nmaxcncp\t#ff2200\ncnlcp\t#aaaaaa\ncsnlcp\t#aaaaaa\nusncp\t#888888\nsncp\t#444444\nbubblecp\t#9abaf3\nfropecp\t#59f459\nchaincp\t#fcaca3\nychaincp\t#ffd163\nspqrscp\t#ffd644\nspqrpcp\t#eb8ef9\nspqrrcp\t#31bf6f\nbicmpcp\t#e9e9e9\ntnbcp\t#994700\ntngbcp\t#994700\nmiscpatterncp\t#c398eb\nusnlcp\t#000000\nsnlcp\t#aaaaaa\nusecp\t#555555\nsecp\t#111111\nhoecp\t#ff0000\nhosecp\t#800000\nloecp\t#0000ff\nlosecp\t#000080\ncngcccp\t#000000\nsngbcp\t#000000\ncpcp\t#994700\nbgcp\t#ffffff\n";var BG_COLOR=undefined;var HIDE_EDGES_ON_VIEWPORT=false;var TEXTURE_ON_VIEWPORT=false;var COMPONENT_EDGE_WEIGHTS=[];var CURR_DB=null;var ASM_FILETYPE;var DNA_AVAILABLE;var REPEAT_INFO_AVAILABLE;var DB_FILENAME;var ASM_NODE_COUNT=0;var ASM_EDGE_COUNT=0;var CURR_NE=0;var PROGRESSBAR_FREQ;var PROGRESSBAR_FREQ_PERCENT=.05;var cy=null;var SELECTED_NODE_COUNT=0;var SELECTED_EDGE_COUNT=0;var SELECTED_CLUSTER_COUNT=0;var SELECTED_NODES=null;var SELECTED_EDGES=null;var SELECTED_CLUSTERS=null;var REMOVED_EDGES=null;var PREV_EDGE_WEIGHT_THRESHOLD=null;var SCAFFOLDID2NODEKEYS={};var COMPONENT_SCAFFOLDS=[];var SCAFFOLD_CYCLER_CURR_INDEX=0;var COMPONENT_HAS_SCAFFOLDS=false;var COMPONENT_NODE_KEYS=[];var FINISHING_MODE_ON=false;var FINISHING_MODE_PREVIOUSLY_DONE=false;var FINISHING_NODE_IDS="";var FINISHING_NODE_OBJS=[];var NEXT_NODES;var MAX_ZOOM_DURING_FINISHING_ANIMATION=2.2;var MAX_ZOOM_ORDINARY=9;var CLUSTERID2TOP=[];var CLUSTER_X=-1;var USE_CLUSTER_KBD_NAV=false;var MODAL_ACTIVE=false;var INPUT_ACTIVE=false;var TD_CLOSE="</td>";var TD_START="<td>";var INTEGER_RE=/^\d+$/;var startDrawDate,endDrawDate;if(!(window.File&&window.FileReader)){alert("Your browser does not support the HTML5 File APIs. "+"You will not be able to upload any .db files, although "+"you can still try out any available demo .db files.")}function initGraph(viewType){CURR_VIEWTYPE=viewType;var tmpColor;if(MAX_RGB===undefined){tmpColor=$("#maxcncp").data("colorpicker").color;MAX_RGB=tmpColor.toRGB();MAX_HEX=tmpColor.toHex()}if(MIN_RGB===undefined){tmpColor=$("#mincncp").data("colorpicker").color;MIN_RGB=tmpColor.toRGB();MIN_HEX=tmpColor.toHex()}BG_COLOR=$("#bgcp").colorpicker("getValue");DEFAULT_NODE_COLOR=$("#usncp").colorpicker("getValue");$("#cy").css("background",BG_COLOR);cy=cytoscape({container:document.getElementById("cy"),layout:{name:"preset"},maxZoom:MAX_ZOOM_ORDINARY,pixelRatio:1,hideEdgesOnViewport:HIDE_EDGES_ON_VIEWPORT,textureOnViewport:TEXTURE_ON_VIEWPORT,userPanningEnabled:false,userZoomingEnabled:false,boxSelectionEnabled:false,autounselectify:true,autoungrabify:true,style:[{selector:"node",style:{width:"data(w)",height:"data(h)"}},{selector:"node.cluster",style:{shape:"rectangle","border-width":0}},{selector:"node.cluster.spqrMetanode",style:{"background-opacity":.65}},{selector:"node.cluster.structuralPattern",style:{"padding-top":0,"padding-right":0,"padding-left":0,"padding-bottom":0,width:"data(w)",height:"data(h)"}},{selector:"node.cluster.structuralPattern[?isCollapsed]",style:{"min-zoomed-font-size":12,"font-size":48,label:"data(interiorNodeCount)","text-valign":"center","font-weight":"bold",color:$("#cngcccp").colorpicker("getValue")}},{selector:"node.F",style:{"background-color":$("#fropecp").colorpicker("getValue"),shape:"polygon"}},{selector:"node.B",style:{"background-color":$("#bubblecp").colorpicker("getValue"),shape:"polygon"}},{selector:"node.B.leftrightdir",style:{"shape-polygon-points":BUBBLE_LEFTRIGHTDIR}},{selector:"node.B.updowndir",style:{"shape-polygon-points":BUBBLE_UPDOWNDIR}},{selector:"node.F.leftrightdir",style:{"shape-polygon-points":FRAYED_ROPE_LEFTRIGHTDIR}},{selector:"node.F.updowndir",style:{"shape-polygon-points":FRAYED_ROPE_UPDOWNDIR}},{selector:"node.C",style:{"background-color":$("#chaincp").colorpicker("getValue")}},{selector:"node.Y",style:{"background-color":$("#ychaincp").colorpicker("getValue"),shape:"ellipse"}},{selector:"node.M",style:{"background-color":$("#miscpatterncp").colorpicker("getValue")}},{selector:"node.cluster.pseudoparent",style:{"z-index-compare":"manual","z-index":0}},{selector:"node.I",style:{"background-color":$("#bicmpcp").colorpicker("getValue")}},{selector:"node.S",style:{"background-color":$("#spqrscp").colorpicker("getValue")}},{selector:"node.P",style:{"background-color":$("#spqrpcp").colorpicker("getValue")}},{selector:"node.R",style:{"background-color":$("#spqrrcp").colorpicker("getValue")}},{selector:"node.bb_enforcing",style:{"background-opacity":0,width:1,height:1}},{selector:"node.noncluster",style:{label:"data(label)","text-valign":"center","min-zoomed-font-size":12,"z-index":2,"z-index-compare":"manual"}},{selector:"node.noncluster.singlenode",style:{shape:"rectangle"}},{selector:"node.noncluster.noncolorized",style:{"background-color":DEFAULT_NODE_COLOR,color:$("#usnlcp").colorpicker("getValue")}},{selector:"node.noncluster.gccolorized",style:{"background-color":"data(gc_color)",color:$("#cnlcp").colorpicker("getValue")}},{selector:"node.noncluster.repeatcolorized",style:{"background-color":"data(repeat_color)",color:$("#cnlcp").colorpicker("getValue")}},{selector:"node.noncluster.updir",style:{"shape-polygon-points":NODE_UPDIR,shape:"polygon"}},{selector:"node.noncluster.downdir",style:{"shape-polygon-points":NODE_DOWNDIR,shape:"polygon"}},{selector:"node.noncluster.leftdir",style:{"shape-polygon-points":NODE_LEFTDIR,shape:"polygon"}},{selector:"node.noncluster.rightdir",style:{"shape-polygon-points":NODE_RIGHTDIR,shape:"polygon"}},{selector:"node.noncluster.tentative",style:{"border-width":5,"border-color":$("#tnbcp").colorpicker("getValue")}},{selector:"node.cluster.tentative",style:{"border-width":5,"border-color":$("#tngbcp").colorpicker("getValue")}},{selector:"node.currpath",style:{"background-color":$("#cpcp").colorpicker("getValue")}},{selector:"node.noncluster:selected",style:{"background-color":$("#sncp").colorpicker("getValue")}},{selector:"node.noncluster.noncolorized:selected",style:{color:$("#snlcp").colorpicker("getValue")}},{selector:"node.noncluster.gccolorized:selected",style:{color:$("#csnlcp").colorpicker("getValue")}},{selector:"node.cluster:selected",style:{"border-width":5,"border-color":$("#sngbcp").colorpicker("getValue")}},{selector:"edge",style:{width:"data(thickness)","line-color":$("#usecp").colorpicker("getValue"),"target-arrow-color":$("#usecp").colorpicker("getValue"),"loop-direction":"30deg","z-index":1,"z-index-compare":"manual"}},{selector:"edge:selected",style:{"line-color":$("#secp").colorpicker("getValue"),"target-arrow-color":$("#secp").colorpicker("getValue")}},{selector:"edge.oriented",style:{"target-arrow-shape":"triangle","target-endpoint":"-50% 0%","source-endpoint":"50% 0"}},{selector:"edge.unoriented_loop",style:{"target-endpoint":"-50% 0%","source-endpoint":"50% 0"}},{selector:"edge.unbundledbezier",style:{"curve-style":"unbundled-bezier","control-point-distances":"data(cpd)","control-point-weights":"data(cpw)","edge-distances":"node-position"}},{selector:"edge.basicbezier",style:{"curve-style":"bezier"}},{selector:"edge.virtual",style:{"line-style":"dashed"}},{selector:"edge.high_outlier",style:{"line-color":$("#hoecp").colorpicker("getValue"),"target-arrow-color":$("#hoecp").colorpicker("getValue")}},{selector:"edge.high_outlier:selected",style:{"line-color":$("#hosecp").colorpicker("getValue"),"target-arrow-color":$("#hosecp").colorpicker("getValue")}},{selector:"edge.low_outlier",style:{"line-color":$("#loecp").colorpicker("getValue"),"target-arrow-color":$("#loecp").colorpicker("getValue")}},{selector:"edge.low_outlier:selected",style:{"line-color":$("#losecp").colorpicker("getValue"),"target-arrow-color":$("#losecp").colorpicker("getValue")}},{selector:"edge.nooverlap",style:{"line-style":"dashed"}}]})}function toggleCluster(cluster){cy.startBatch();if(cluster.data("isCollapsed")){uncollapseCluster(cluster)}else{collapseCluster(cluster)}cy.endBatch()}function collapseCluster(cluster,moveMap){var children=cluster.children();if(FINISHING_MODE_ON){for(var ci=0;ci<children.length;ci++){if(children[ci].hasClass("tentative")){return}}}for(var incomingEdgeID in cluster.data("incomingEdgeMap")){var oldEdge=cy.getElementById(incomingEdgeID);oldEdge.removeClass("unbundledbezier");oldEdge.addClass("basicbezier");oldEdge.move({target:cluster.id()})}for(var outgoingEdgeID in cluster.data("outgoingEdgeMap")){var oldEdge=cy.getElementById(outgoingEdgeID);oldEdge.removeClass("unbundledbezier");oldEdge.addClass("basicbezier");oldEdge.move({source:cluster.id()})}cluster.data("isCollapsed",true);cy.scratch("_collapsed",cy.scratch("_collapsed").union(cluster));cy.scratch("_uncollapsed",cy.scratch("_uncollapsed").difference(cluster));if(cy.scratch("_uncollapsed").empty()){if($("#collapseButtonText").text()[0]==="C"){changeCollapseButton(true)}}cluster.scratch("_interiorEles").unselect();cluster.scratch("_interiorEles").remove()}function uncollapseCluster(cluster){if(FINISHING_MODE_ON){if(cluster.hasClass("tentative")){return}}cluster.scratch("_interiorEles").restore();for(var incomingEdgeID in cluster.data("incomingEdgeMap")){if(REMOVED_EDGES.is('[id="'+incomingEdgeID+'"]')){continue}var newTgt=cluster.data("incomingEdgeMap")[incomingEdgeID][1];var oldEdge=cy.getElementById(incomingEdgeID);if(!oldEdge.source().hasClass("cluster")&&oldEdge.data("cpd")){if(!oldEdge.hasClass("reducededge")){oldEdge.removeClass("basicbezier");oldEdge.addClass("unbundledbezier")}}oldEdge.move({target:newTgt})}for(var outgoingEdgeID in cluster.data("outgoingEdgeMap")){if(REMOVED_EDGES.is('[id="'+outgoingEdgeID+'"]')){continue}var newSrc=cluster.data("outgoingEdgeMap")[outgoingEdgeID][0];var oldEdge=cy.getElementById(outgoingEdgeID);if(!oldEdge.target().hasClass("cluster")&&oldEdge.data("cpd")){if(!oldEdge.hasClass("reducededge")){oldEdge.removeClass("basicbezier");oldEdge.addClass("unbundledbezier")}}oldEdge.move({source:newSrc})}cluster.data("isCollapsed",false);cy.scratch("_collapsed",cy.scratch("_collapsed").difference(cluster));cy.scratch("_uncollapsed",cy.scratch("_uncollapsed").union(cluster));if(cy.scratch("_collapsed").empty()){if($("#collapseButtonText").text()[0]==="U"){changeCollapseButton(false)}}}function addSelectedNodeInfo(ele){var lengthEntry=ele.data("length").toLocaleString();if(ASM_FILETYPE==="GML"||CURR_VIEWTYPE==="SPQR"){lengthEntry+=" bp"}else{lengthEntry+=" nt"}var eleID=ele.id();var nodeRowHTML="<tr class='nonheader' id='row"+eleID+"'><td>";if(CURR_VIEWTYPE==="SPQR"){nodeRowHTML+=eleID.split("_")[0]}else{nodeRowHTML+=eleID}nodeRowHTML+=TD_CLOSE;if(ASM_FILETYPE==="GML"){nodeRowHTML+=TD_START+ele.data("label")+TD_CLOSE}nodeRowHTML+=TD_START+lengthEntry+TD_CLOSE;if(ASM_FILETYPE==="LastGraph"||ASM_FILETYPE==="FASTG"){var depthEntry=Math.round(ele.data("depth")*100)/100+"x";nodeRowHTML+=TD_START+depthEntry+TD_CLOSE}if(DNA_AVAILABLE){var gcEntry=Math.round(ele.data("gc_content")*1e4)/100+"%";nodeRowHTML+=TD_START+gcEntry+TD_CLOSE}if(REPEAT_INFO_AVAILABLE){var is_repeat=ele.data("is_repeat");var repeatEntry;if(is_repeat===1){repeatEntry="True"}else if(is_repeat===0){repeatEntry="False"}else{repeatEntry="N/A"}nodeRowHTML+=TD_START+repeatEntry+TD_CLOSE}nodeRowHTML+="</tr>";$("#nodeInfoTable").append(nodeRowHTML)}function addSelectedEdgeInfo(ele){var displaySourceID,displayTargetID;if(CURR_VIEWTYPE==="SPQR"&&ele.data("dispsrc")!==undefined){displaySourceID=ele.data("dispsrc");displayTargetID=ele.data("disptgt")}else{displaySourceID=ele.source().id();displayTargetID=ele.target().id()}var edgeRowHTML="<tr class='nonheader' id='row"+ele.id().replace(">","")+"'><td>"+displaySourceID+"</td><td>"+displayTargetID+TD_CLOSE;if(ASM_FILETYPE==="GML"||ASM_FILETYPE==="LastGraph")edgeRowHTML+=TD_START;if(CURR_VIEWTYPE!=="SPQR"){edgeRowHTML+=ele.data("multiplicity")}else{edgeRowHTML+="N/A"}edgeRowHTML+=TD_CLOSE;if(ASM_FILETYPE==="GML"){if(CURR_VIEWTYPE==="SPQR"){edgeRowHTML+="<td>N/A</td>N/A<td>N/A</td>N/A<td>N/A</td>"}else{var meanEntry=Math.round(ele.data("mean")*100)/100;var stdevEntry=Math.round(ele.data("stdev")*100)/100;edgeRowHTML+=TD_START+ele.data("orientation")+TD_CLOSE;edgeRowHTML+=TD_START+meanEntry+TD_CLOSE;edgeRowHTML+=TD_START+stdevEntry+TD_CLOSE}}edgeRowHTML+="</tr>";$("#edgeInfoTable").append(edgeRowHTML)}function addSelectedClusterInfo(ele){var clustID=ele.data("id");var clustType;switch(clustID[0]){case"C":clustType="Chain";break;case"Y":clustType="Cyclic Chain";break;case"B":clustType="Bubble";break;case"F":clustType="Frayed Rope";break;case"M":clustType=ele.data("cluster_type");break;case"I":clustType="Bicomponent";break;case"S":clustType="Series Metanode";break;case"P":clustType="Parallel Metanode";break;case"R":clustType="Rigid Metanode";break;default:clustType="Invalid (error)"}var clustSize=ele.data("interiorNodeCount");$("#clusterInfoTable").append("<tr class='nonheader' id='row"+ele.id()+"'><td>"+clustType+"</td><td>"+clustSize+"</td></tr>")}function removeSelectedEleInfo(ele){$("#row"+ele.id().replace(">","")).remove()}function setEnterBinding(inputID,f){$("#"+inputID).on("keypress",function(e){if(e.which===13){f()}})}function doThingsWhenDOMReady(){setEnterBinding("searchInput",searchForEles);setEnterBinding("layoutInput",testLayout);setEnterBinding("componentselector",function(){startDrawComponent("double")});setEnterBinding("SPQRcomponentselector",function(){startDrawComponent("SPQR")});setEnterBinding("binCountInput",drawEdgeWeightHistogram);setEnterBinding("cullEdgesInput",cullEdges);var dialogIDs=["settingsDialog","fsDialog","infoDialog","edgeFilteringDialog"];for(var d=0;d<dialogIDs.length;d++){$("#"+dialogIDs[d]).on("show.bs.modal",function(e){MODAL_ACTIVE=true});if(dialogIDs[d]==="settingsDialog"){$("#settingsDialog").on("hide.bs.modal",function(e){$(".colorpicker-component").colorpicker("hide");MODAL_ACTIVE=false})}else{$("#"+dialogIDs[d]).on("hide.bs.modal",function(e){MODAL_ACTIVE=false})}}var inputIDs=["componentselector","SPQRcomponentselector","searchInput","layoutInput"];for(var i=0;i<inputIDs.length;i++){$("#"+inputIDs[i]).on("focusin",function(e){INPUT_ACTIVE=true});$("#"+inputIDs[i]).on("focusout",function(e){INPUT_ACTIVE=false})}$(".colorpicker-component").colorpicker({format:"hex"});$("#mincncp").on("changeColor",function(e){redrawGradientPreview(e.color.toHex(),-1)});$("#maxcncp").on("changeColor",function(e){redrawGradientPreview(e.color.toHex(),1)});$("#100gp").css("background-color",$("#maxcncp").colorpicker("getValue"));redrawGradientPreview($("#mincncp").colorpicker("getValue"),-1)}function moveThroughClusters(e){if(!MODAL_ACTIVE&&!INPUT_ACTIVE){if(e.which===37||e.which===65){if(CLUSTER_X<=0){CLUSTER_X=CLUSTERID2TOP.length-1}else{CLUSTER_X--}cy.fit(cy.getElementById(CLUSTERID2TOP[CLUSTER_X].id))}else if(e.which===39||e.which===68){if(CLUSTER_X===CLUSTERID2TOP.length-1){CLUSTER_X=0}else{CLUSTER_X++}cy.fit(cy.getElementById(CLUSTERID2TOP[CLUSTER_X].id))}}}function doThingsBeforeUnload(){closeDB()}function setGraphBindings(){cy.on("cxttap","node.cluster.structuralPattern",function(e){if(!$("#fitButton").hasClass("disabled")){toggleCluster(e.target)}});if($("#autozoomClusterCheckbox").prop("checked")){cy.on("tap","node.cluster.structuralPattern",function(e){cy.animate({fit:{eles:e.target}})})}cy.on("cxttap","node.cluster.spqrMetanode",function(e){if(!$("#fitButton").hasClass("disabled")){var mn=e.target;if(mn.data("descendantCount")>0){if(mn.data("isCollapsed")){cy.batch(function(){uncollapseSPQRMetanode(mn)})}else{cy.batch(function(){collapseSPQRMetanode(mn)})}}}});cy.on("select","node.noncluster, edge, node.cluster",function(e){var x=e.target;if(x.hasClass("noncluster")){SELECTED_NODE_COUNT+=1;SELECTED_NODES=SELECTED_NODES.union(x);$("#selectedNodeBadge").text(SELECTED_NODE_COUNT);addSelectedNodeInfo(x)}else if(x.isEdge()){SELECTED_EDGE_COUNT+=1;SELECTED_EDGES=SELECTED_EDGES.union(x);$("#selectedEdgeBadge").text(SELECTED_EDGE_COUNT);addSelectedEdgeInfo(x)}else{SELECTED_CLUSTER_COUNT+=1;SELECTED_CLUSTERS=SELECTED_CLUSTERS.union(x);$("#selectedClusterBadge").text(SELECTED_CLUSTER_COUNT);addSelectedClusterInfo(x)}if(SELECTED_NODE_COUNT+SELECTED_EDGE_COUNT+SELECTED_CLUSTER_COUNT===1){enableButton("fitSelectedButton")}});cy.on("unselect","node.noncluster, edge, node.cluster",function(e){var x=e.target;if(x.hasClass("noncluster")){SELECTED_NODE_COUNT-=1;SELECTED_NODES=SELECTED_NODES.difference(x);$("#selectedNodeBadge").text(SELECTED_NODE_COUNT);removeSelectedEleInfo(x)}else if(x.isEdge()){SELECTED_EDGE_COUNT-=1;SELECTED_EDGES=SELECTED_EDGES.difference(x);$("#selectedEdgeBadge").text(SELECTED_EDGE_COUNT);removeSelectedEleInfo(x)}else{SELECTED_CLUSTER_COUNT-=1;SELECTED_CLUSTERS=SELECTED_CLUSTERS.difference(x);$("#selectedClusterBadge").text(SELECTED_CLUSTER_COUNT);removeSelectedEleInfo(x)}if(SELECTED_NODE_COUNT+SELECTED_EDGE_COUNT+SELECTED_CLUSTER_COUNT<=0){disableButton("fitSelectedButton")}})}function rotateNode(n,i){var oldPt=n.position();var newPt=rotateCoordinate(oldPt["x"],oldPt["y"]);n.position({x:newPt[0],y:newPt[1]});if(n.hasClass("noncluster")){if(n.hasClass("updir"))n.removeClass("updir");else if(n.hasClass("downdir"))n.removeClass("downdir");else if(n.hasClass("leftdir"))n.removeClass("leftdir");else if(n.hasClass("rightdir"))n.removeClass("rightdir");n.addClass(getNodeCoordClass(n.data("house")))}else if(n.hasClass("B")||n.hasClass("F")){if(n.hasClass("updowndir"))n.removeClass("updowndir");else if(n.hasClass("leftrightdir"))n.removeClass("leftrightdir");n.addClass(getClusterCoordClass())}}function changeRotation(){PREV_ROTATION=CURR_ROTATION;CURR_ROTATION=parseInt($("#rotationButtonGroup .btn.active").attr("value"));if(!$("#fitButton").hasClass("disabled")){startIndeterminateProgressBar();window.setTimeout(function(){cy.startBatch();cy.filter("node").each(rotateNode);cy.scratch("_collapsed").each(function(n,i){n.scratch("_interiorNodes").each(rotateNode)});cy.endBatch();cy.fit();finishProgressBar()},20)}}function changeCollapseButton(toUncollapseReady){if(toUncollapseReady){$("#collapseButtonText").text("Uncollapse all node groups");$("#collapseButtonIcon").removeClass("glyphicon-minus-sign").addClass("glyphicon-plus-sign")}else{$("#collapseButtonText").text("Collapse all node groups");$("#collapseButtonIcon").removeClass("glyphicon-plus-sign").addClass("glyphicon-minus-sign")}}function destroyGraph(){cy.destroy();changeCollapseButton(false)}function loadgraphfile(){var fr=new FileReader;var inputfile=document.getElementById("fileselector").files[0];if(inputfile===undefined){return}if(inputfile.name.toLowerCase().endsWith(".db")){DB_FILENAME=inputfile.name;closeDB();disableVolatileControls();$("#selectedNodeBadge").text(0);$("#selectedEdgeBadge").text(0);$("#selectedClusterBadge").text(0);disableButton("infoButton");$("#currComponentInfo").html("No connected component has been drawn yet.");fr.onload=function(e){if(e.target.readyState===FileReader.DONE){loadDBfile(e.target.result);document.getElementById("fileselector").value=""}};startIndeterminateProgressBar();window.setTimeout(function(){fr.readAsArrayBuffer(inputfile)},50)}else{alert("Please select a valid .db file to load.")}}function loadDBfile(fileData){var uIntArr=new Uint8Array(fileData);CURR_DB=new SQL.Database(uIntArr);parseDBcomponents();finishProgressBar()}function parseDBcomponents(){if(cy!==null){destroyGraph()}var stmt=CURR_DB.prepare("SELECT * FROM assembly;");stmt.step();var graphInfo=stmt.getAsObject();stmt.free();var fnInfo=graphInfo["filename"];ASM_FILETYPE=graphInfo["filetype"];ASM_NODE_COUNT=graphInfo["node_count"];var nodeInfo=ASM_NODE_COUNT.toLocaleString();var bpCt=graphInfo["total_length"];var bpInfo=bpCt.toLocaleString();ASM_EDGE_COUNT=graphInfo["all_edge_count"];var edgeCount=graphInfo["edge_count"];var edgeInfo=edgeCount.toLocaleString();var compCt=graphInfo["component_count"];var compInfo=compCt.toLocaleString();var sccCt=graphInfo["single_component_count"];var sccInfo=sccCt.toLocaleString();var bicmpCt=graphInfo["bicomponent_count"];var bicmpInfo=bicmpCt.toLocaleString();var n50=graphInfo["n50"];var n50Info=n50.toLocaleString();var asmGC=graphInfo["gc_content"];DNA_AVAILABLE=graphInfo["dna_given"]===1?true:false;REPEAT_INFO_AVAILABLE=graphInfo["repeats_given"]===1?true:false;if(ASM_FILETYPE==="LastGraph"||ASM_FILETYPE==="GFA"||ASM_FILETYPE==="FASTG"){$("#asmNodeCtTH").text("Positive Node Count");$("#asmEdgeCtTH").text("Positive Edge Count");$("#asmNodeLenTH").text("Total Positive Node Length");n50Info+=" nt";bpInfo+=" nt"}else{$("#asmNodeCtTH").text("Node Count");$("#asmEdgeCtTH").text("Edge Count");$("#asmNodeLenTH").text("Total Node Length");n50Info+=" bp";bpInfo+=" bp"}if(DNA_AVAILABLE){var asmGCInfo=Math.round(asmGC*100*100)/100+"%";$("#asmGCEntry").text(asmGCInfo);$("#asmGCTH").removeClass("notviewable");$("#asmGCEntry").removeClass("notviewable")}else{$("#asmGCTH").addClass("notviewable");$("#asmGCEntry").addClass("notviewable")}document.title=DB_FILENAME+" ("+fnInfo+")";$("#filenameEntry").text(fnInfo);$("#filetypeEntry").text(ASM_FILETYPE);$("#nodeCtEntry").text(nodeInfo);$("#totalBPLengthEntry").text(bpInfo);$("#edgeCountEntry").text(edgeInfo);$("#sccCountEntry").text(sccInfo);$("#bicmpCountEntry").text(bicmpInfo);$("#connCmpCtEntry").text(compInfo);$("#n50Entry").text(n50Info);$("#componentselector").prop("max",compCt);$("#componentselector").prop("disabled",false);enableButton("decrCompRankButton");enableButton("incrCompRankButton");enableButton("drawButton");$("#SPQRcomponentselector").prop("max",sccCt);$("#SPQRcomponentselector").prop("disabled",false);enableButton("decrSPQRCompRankButton");enableButton("incrSPQRCompRankButton");enableButton("drawSPQRButton");enableButton("implicitSPQROption");enableButton("explicitSPQROption");SCAFFOLDID2NODEKEYS={};BICOMPONENTID2VISIBLESINGLENODEIDS={};$("#agpLoadedFileName").addClass("notviewable");$("#scaffoldInfoHeader").addClass("notviewable");$("#scaffoldCycler").addClass("notviewable");COMPONENT_NODE_KEYS=[];$("#assembledNodes").empty();FINISHING_MODE_ON=false;FINISHING_MODE_PREVIOUSLY_DONE=false;FINISHING_NODE_IDS="";FINISHING_NODE_OBJS=[];$("#noneColorization").prop("checked",true);enableButton("xmlFileselectButton");enableButton("fileselectButton");enableButton("loadDBbutton");enableButton("infoButton");enableButton("dir0");enableButton("dir90");enableButton("dir180");enableButton("dir270");enableButton("settingsButton");var extraNodeCols=0;if(DNA_AVAILABLE){$("#gcContentCol").removeClass("notviewable");extraNodeCols++}else{$("#gcContentCol").addClass("notviewable")}if(REPEAT_INFO_AVAILABLE){$("#repeatCol").removeClass("notviewable");extraNodeCols++}else{$("#repeatCol").addClass("notviewable")}if(ASM_FILETYPE==="GML"){$("#nodeTH").prop("colspan",3+extraNodeCols);$("#depthCol").addClass("notviewable");$("#labelCol").removeClass("notviewable");$("#edgeTH").prop("colspan",6);$("#multiplicityCol").text("B. size");$("#multiplicityCol").removeClass("notviewable");$("#orientationCol").removeClass("notviewable");$("#meanCol").removeClass("notviewable");$("#stdevCol").removeClass("notviewable")}else if(ASM_FILETYPE==="LastGraph"){$("#nodeTH").prop("colspan",3+extraNodeCols);$("#depthCol").removeClass("notviewable");$("#labelCol").addClass("notviewable");$("#edgeTH").prop("colspan",3);$("#multiplicityCol").text("Multiplicity");$("#multiplicityCol").removeClass("notviewable");$("#orientationCol").addClass("notviewable");$("#meanCol").addClass("notviewable");$("#stdevCol").addClass("notviewable")}else if(ASM_FILETYPE==="GFA"){$("#nodeTH").prop("colspan",2+extraNodeCols);$("#depthCol").addClass("notviewable");$("#labelCol").addClass("notviewable");$("#edgeTH").prop("colspan",2);$("#multiplicityCol").addClass("notviewable");$("#orientationCol").addClass("notviewable");$("#meanCol").addClass("notviewable");$("#stdevCol").addClass("notviewable")}else if(ASM_FILETYPE==="FASTG"){$("#nodeTH").prop("colspan",3+extraNodeCols);$("#depthCol").removeClass("notviewable");$("#labelCol").addClass("notviewable");$("#edgeTH").prop("colspan",2);$("#multiplicityCol").addClass("notviewable");$("#orientationCol").addClass("notviewable");$("#meanCol").addClass("notviewable");$("#stdevCol").addClass("notviewable")}}function enableButton(buttonID){$("#"+buttonID).removeClass("disabled");$("#"+buttonID).prop("disabled",false)}function disableButton(buttonID){$("#"+buttonID).addClass("disabled");$("#"+buttonID).prop("disabled",true)}function disableInlineRadio(inputID){$("#"+inputID).prop("disabled",true)}function enableInlineRadio(inputID){$("#"+inputID).prop("disabled",false)}function disableVolatileControls(){disableButton("settingsButton");$("#componentselector").prop("disabled",true);disableButton("decrCompRankButton");disableButton("incrCompRankButton");disableButton("drawButton");$("#SPQRcomponentselector").prop("disabled",true);disableButton("decrSPQRCompRankButton");disableButton("incrSPQRCompRankButton");disableButton("drawSPQRButton");disableButton("implicitSPQROption");disableButton("explicitSPQROption");disableButton("fileselectButton");disableButton("loadDBbutton");disableButton("xmlFileselectButton");$("#searchInput").prop("disabled",true);$("#layoutInput").prop("disabled",true);disableButton("filterEdgesButton");disableButton("reduceEdgesButton");disableButton("layoutButton");disableButton("scaffoldFileselectButton");disableButton("startFinishingButton");disableButton("endFinishingButton");disableButton("exportPathButton");disableButton("agpOption");disableButton("csvOption");disableButton("floatingExportButton");$("#assembledNodes").empty();disableButton("searchButton");disableButton("collapseButton");disableButton("fitSelectedButton");disableButton("fitButton");disableButton("exportImageButton");disableButton("dir0");disableButton("dir90");disableButton("dir180");disableButton("dir270");disableButton("pngOption");disableButton("jpgOption");disableButton("changeNodeColorizationButton");disableInlineRadio("noneColorization");disableInlineRadio("gcColorization");disableInlineRadio("repeatColorization");clearSelectedInfo()}function updateTextStatus(text,notDuringDrawing){if(notDuringDrawing||$("#useDrawingStatusTextCheckbox").prop("checked")){$("#textStatus").html(text)}}function toggleHEV(){HIDE_EDGES_ON_VIEWPORT=!HIDE_EDGES_ON_VIEWPORT}function toggleUTV(){TEXTURE_ON_VIEWPORT=!TEXTURE_ON_VIEWPORT}function toggleClusterNav(){USE_CLUSTER_KBD_NAV=!USE_CLUSTER_KBD_NAV}function compRankValidity(strVal,csIDstr){if(strVal.match(INTEGER_RE)===null)return null;var intVal=parseInt(strVal);if(intVal<parseInt($(csIDstr).prop("min")))return-1;if(intVal>parseInt($(csIDstr).prop("max")))return 1;return 0}function decrCompRank(componentSelectorID){var csIDstr="#"+componentSelectorID;var currRank=$(csIDstr).val();var minRank=parseInt($(csIDstr).prop("min"));var validity=compRankValidity(currRank,csIDstr);if(validity===null||parseInt(currRank)<minRank+1){$(csIDstr).val(minRank)}else if(validity===1){$(csIDstr).val($(csIDstr).prop("max"))}else{$(csIDstr).val(parseInt(currRank)-1)}}function incrCompRank(componentSelectorID){var csIDstr="#"+componentSelectorID;var currRank=$(csIDstr).val();var maxRank=parseInt($(csIDstr).prop("max"));var validity=compRankValidity(currRank,csIDstr);if(validity===null||validity===-1){$(csIDstr).val($(csIDstr).prop("min"))}else if(currRank>maxRank-1){$(csIDstr).val(maxRank)}else{$(csIDstr).val(parseInt(currRank)+1)}}function startDrawComponent(mode){startDrawDate=new Date;var selector="#componentselector";var drawFunc=drawComponent;if(mode=="SPQR"){selector="#SPQRcomponentselector";drawFunc=drawSPQRComponent}var currRank=$(selector).val();if(compRankValidity(currRank,selector)!==0){alert("Please enter a valid component rank using the input field.");return}updateTextStatus("Drawing clusters...",false);window.setTimeout(drawFunc(parseInt(currRank)),0)}function drawSPQRComponent(cmpRank){disableVolatileControls();if(cy!==null){destroyGraph()}initGraph("SPQR");CURR_SPQRMODE=$("#decompositionOptionButtonGroup .btn.active").attr("value");setGraphBindings();$(document).off("keydown");var componentNodeCount=0;var componentEdgeCount=0;SELECTED_NODES=cy.collection();SELECTED_EDGES=cy.collection();SELECTED_CLUSTERS=cy.collection();SELECTED_NODE_COUNT=0;SELECTED_EDGE_COUNT=0;SELECTED_CLUSTER_COUNT=0;COMPONENT_EDGE_WEIGHTS=[];CLUSTERID2TOP=[];CLUSTER_X=-1;$("#selectedNodeBadge").text(0);$("#selectedEdgeBadge").text(0);$("#selectedClusterBadge").text(0);BICOMPONENTID2VISIBLESINGLENODEIDS={};$("#searchForElementsControls").addClass("notviewable");$("#assemblyFinishingControls").addClass("notviewable");$("#viewScaffoldsControls").addClass("notviewable");$("#testLayoutsControls").addClass("notviewable");$("#collapseButtonControls").addClass("notviewable");$("#noneColorization").prop("checked",true);CURR_NODE_COLORIZATION="noncolorized";PREV_ROTATION=0;CURR_ROTATION=90;cy.scratch("_collapsed",cy.collection());cy.scratch("_uncollapsed",cy.collection());cy.scratch("_ele2parent",{});var query;if(CURR_SPQRMODE==="explicit"){query="SELECT boundingbox_x, boundingbox_y,"+" ex_uncompressed_node_count, ex_uncompressed_edge_count,"+" compressed_node_count, compressed_edge_count,"+" bicomponent_count FROM singlecomponents WHERE size_rank = ?"+" LIMIT 1"}else{query="SELECT i_boundingbox_x, i_boundingbox_y,"+" im_uncompressed_node_count, im_uncompressed_edge_count,"+" compressed_node_count, compressed_edge_count,"+" bicomponent_count FROM singlecomponents"+" WHERE size_rank = ? LIMIT 1"}var bbStmt=CURR_DB.prepare(query,[cmpRank]);bbStmt.step();var fullObj=bbStmt.getAsObject();bbStmt.free();var bb;if(CURR_SPQRMODE==="explicit"){bb={boundingbox_x:fullObj["boundingbox_x"],boundingbox_y:fullObj["boundingbox_y"]}}else{bb={boundingbox_x:fullObj["i_boundingbox_x"],boundingbox_y:fullObj["i_boundingbox_y"]}}var bicmpCount=fullObj["bicomponent_count"];var cNodeCount=fullObj["compressed_node_count"];var cEdgeCount=fullObj["compressed_edge_count"];var totalElementCount=.5*cEdgeCount+cNodeCount;var ucNodeCount=null;var ucEdgeCount=null;if(CURR_SPQRMODE==="explicit"){ucNodeCount=fullObj["ex_uncompressed_node_count"];ucEdgeCount=fullObj["ex_uncompressed_edge_count"]}else{ucNodeCount=fullObj["im_uncompressed_node_count"];ucEdgeCount=fullObj["im_uncompressed_edge_count"]}PROGRESSBAR_FREQ=Math.floor(PROGRESSBAR_FREQ_PERCENT*totalElementCount);var node2pos={};var bicmpsInComponent=false;cy.startBatch();var bicmpsStmt=CURR_DB.prepare("SELECT * FROM bicomponents WHERE scc_rank = ?",[cmpRank]);var bicmpObj;var metanodeParams=[cmpRank];var rootmnQuestionMarks="(?,";while(bicmpsStmt.step()){bicmpsInComponent=true;bicmpObj=bicmpsStmt.getAsObject();renderClusterObject(bicmpObj,bb,"bicomponent");metanodeParams.push(bicmpObj["root_metanode_id"]);rootmnQuestionMarks+="?,"}bicmpsStmt.free();rootmnQuestionMarks=rootmnQuestionMarks.substr(0,rootmnQuestionMarks.lastIndexOf(","))+")";var da;var metanodesStmt=CURR_DB.prepare("SELECT * FROM metanodes WHERE scc_rank = ? AND metanode_id IN"+rootmnQuestionMarks,metanodeParams);while(metanodesStmt.step()){da=renderClusterObject(metanodesStmt.getAsObject(),bb,"metanode");node2pos[da[0]]=da[1]}metanodesStmt.free();drawBoundingBoxEnforcingNodes(bb);cy.endBatch();cy.fit();updateTextStatus("Drawing nodes...",false);window.setTimeout(function(){cy.startBatch();var spqrSpecs="WHERE scc_rank = ? AND (parent_metanode_id IS NULL "+"OR parent_metanode_id IN"+rootmnQuestionMarks+")";var nodesStmt=CURR_DB.prepare("SELECT * FROM singlenodes "+spqrSpecs,metanodeParams);CURR_NE=0;drawComponentNodes(nodesStmt,bb,cmpRank,node2pos,bicmpsInComponent,componentNodeCount,componentEdgeCount,totalElementCount,"SPQR",spqrSpecs,metanodeParams,[cNodeCount,cEdgeCount,ucNodeCount,ucEdgeCount,bicmpCount])},0)}function drawComponent(cmpRank){disableVolatileControls();if(cy!==null){destroyGraph()}initGraph("double");setGraphBindings();$(document).off("keydown");var componentNodeCount=0;var componentEdgeCount=0;SELECTED_NODES=cy.collection();SELECTED_EDGES=cy.collection();SELECTED_CLUSTERS=cy.collection();COMPONENT_EDGE_WEIGHTS=[];CLUSTERID2TOP=[];CLUSTER_X=-1;$("#scaffoldCycler").addClass("notviewable");COMPONENT_HAS_SCAFFOLDS=false;$("#scaffoldInfoHeader").addClass("notviewable");COMPONENT_NODE_KEYS=[];$("#assembledNodes").empty();FINISHING_MODE_ON=false;FINISHING_MODE_PREVIOUSLY_DONE=false;FINISHING_NODE_IDS="";FINISHING_NODE_OBJS=[];NEXT_NODES=cy.collection();SELECTED_NODE_COUNT=0;SELECTED_EDGE_COUNT=0;SELECTED_CLUSTER_COUNT=0;REMOVED_EDGES=cy.collection();$("#selectedNodeBadge").text(0);$("#selectedEdgeBadge").text(0);$("#selectedClusterBadge").text(0);BICOMPONENTID2VISIBLESINGLENODEIDS={};$("#searchForElementsControls").removeClass("notviewable");$("#assemblyFinishingControls").removeClass("notviewable");$("#viewScaffoldsControls").removeClass("notviewable");$("#testLayoutsControls").removeClass("notviewable");$("#collapseButtonControls").removeClass("notviewable");$("#noneColorization").prop("checked",true);CURR_NODE_COLORIZATION="noncolorized";PREV_ROTATION=0;CURR_ROTATION=90;cy.scratch("_collapsed",cy.collection());cy.scratch("_uncollapsed",cy.collection());cy.scratch("_ele2parent",{});var bbStmt=CURR_DB.prepare("SELECT boundingbox_x, boundingbox_y, node_count, edge_count FROM components WHERE "+"size_rank = ? LIMIT 1",[cmpRank]);bbStmt.step();var fullObj=bbStmt.getAsObject();bbStmt.free();var bb={boundingbox_x:fullObj["boundingbox_x"],boundingbox_y:fullObj["boundingbox_y"]};var totalElementCount=fullObj["node_count"]+.5*fullObj["edge_count"];PROGRESSBAR_FREQ=Math.floor(PROGRESSBAR_FREQ_PERCENT*totalElementCount);var node2pos={};var clustersInComponent=false;cy.startBatch();var clustersStmt=CURR_DB.prepare("SELECT * FROM clusters WHERE component_rank = ?",[cmpRank]);while(clustersStmt.step()){clustersInComponent=true;renderClusterObject(clustersStmt.getAsObject(),bb,"cluster")}clustersStmt.free();drawBoundingBoxEnforcingNodes(bb);cy.endBatch();cy.fit();updateTextStatus("Drawing nodes...",false);window.setTimeout(function(){cy.startBatch();var nodesStmt=CURR_DB.prepare("SELECT * FROM nodes WHERE component_rank = ?",[cmpRank]);CURR_NE=0;drawComponentNodes(nodesStmt,bb,cmpRank,node2pos,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,"double","",[],[])},0)}function drawComponentNodes(nodesStmt,bb,cmpRank,node2pos,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,mode,spqrSpecs,metanodeParams,counts){if(nodesStmt.step()){var currNode=nodesStmt.getAsObject();var currNodeID=currNode["id"];var parentMetaNodeID=currNode["parent_metanode_id"];if(mode==="SPQR"&&parentMetaNodeID!==null){currNodeID+="_"+parentMetaNodeID}node2pos[currNodeID]=renderNodeObject(currNode,currNodeID,bb,mode);componentNodeCount+=1;CURR_NE+=1;if(CURR_NE%PROGRESSBAR_FREQ===0){updateProgressBar(CURR_NE/totalElementCount*100);window.setTimeout(function(){drawComponentNodes(nodesStmt,bb,cmpRank,node2pos,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,mode,spqrSpecs,metanodeParams,counts)},0)}else{drawComponentNodes(nodesStmt,bb,cmpRank,node2pos,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,mode,spqrSpecs,metanodeParams,counts)}}else{nodesStmt.free();cy.endBatch();cy.fit();updateTextStatus("Drawing edges...",false);cy.startBatch();var edgesStmt;var edgeType="doubleedge";if(mode!=="SPQR"){edgesStmt=CURR_DB.prepare("SELECT * FROM edges WHERE component_rank = ?",[cmpRank])}else{edgeType="singleedge";edgesStmt=CURR_DB.prepare("SELECT * FROM singleedges "+spqrSpecs,metanodeParams)}drawComponentEdges(edgesStmt,bb,node2pos,cmpRank,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,edgeType,mode,counts)}}function drawComponentEdges(edgesStmt,bb,node2pos,cmpRank,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,edgeType,mode,counts){if(edgesStmt.step()){renderEdgeObject(edgesStmt.getAsObject(),node2pos,bb,edgeType,mode,{});componentEdgeCount+=1;CURR_NE+=.5;if(CURR_NE%PROGRESSBAR_FREQ===0){updateProgressBar(CURR_NE/totalElementCount*100);window.setTimeout(function(){drawComponentEdges(edgesStmt,bb,node2pos,cmpRank,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,edgeType,mode,counts)},0)}else{drawComponentEdges(edgesStmt,bb,node2pos,cmpRank,clustersInComponent,componentNodeCount,componentEdgeCount,totalElementCount,edgeType,mode,counts)}}else{edgesStmt.free();CURR_BOUNDINGBOX=bb;finishDrawComponent(cmpRank,componentNodeCount,componentEdgeCount,clustersInComponent,mode,counts)}}function updateCurrCompInfo(cmpRank,componentNodeCount,componentEdgeCount,mode,counts){var intro="The ";var nodePercentage,edgePercentage;if(mode!=="SPQR"){var nodePercentage=componentNodeCount/ASM_NODE_COUNT*100;if(ASM_EDGE_COUNT!==0){var edgePercentage=componentEdgeCount/ASM_EDGE_COUNT*100}else{var edgePercentage="None"}}var all_nodes_edges_modifier="the";if(mode!=="SPQR"&&$("#filetypeEntry").text()!=="GML"){intro="Including <strong>both positive and negative</strong>"+" nodes and edges, the ";nodePercentage/=2;all_nodes_edges_modifier="all positive and negative"}var bodyText=intro+"current connected component (size rank <strong>"+cmpRank+"</strong>) ";if(mode==="SPQR"){bodyText+="in the SPQR view, when fully collapsed, has <strong>"+counts[0]+" "+getSuffix(counts[0],"node")+"</strong> and "+"<strong>"+counts[1]+" "+getSuffix(counts[1],"edge")+"</strong>. When fully "+CURR_SPQRMODE+"ly uncollapsed, "+"the connected component has <strong>"+counts[2]+" "+getSuffix(counts[2],"node")+"</strong> and "+"<strong>"+counts[3]+" "+getSuffix(counts[3],"edge")+"</strong>. The connected component has <strong>"+counts[4]+" "+getSuffix(counts[4],"biconnected component")+"</strong>. ";if(CURR_SPQRMODE==="explicit"){bodyText+="(These figures do not include SPQR tree metanodes, "+"although they do include the edges between them when "+"uncollapsed.)"}}else{var nodeNoun=getSuffix(componentNodeCount,"node");var edgeNoun=getSuffix(componentEdgeCount,"edge");bodyText+="has <strong>"+componentNodeCount+" "+nodeNoun+"</strong> and <strong>"+componentEdgeCount+" "+edgeNoun+"</strong>. This connected component contains <strong>"+nodePercentage.toFixed(2)+"% of "+all_nodes_edges_modifier+" nodes</strong> in the assembly";if(edgePercentage!=="None"){bodyText+=" and <strong>"+edgePercentage.toFixed(2)+"% of "+all_nodes_edges_modifier+" edges</strong> in the assembly."}else{bodyText+=". There are no edges in the assembly."}}$("#currComponentInfo").html(bodyText)}function getSuffix(countOfSomething,noun){return countOfSomething===1?noun:noun+"s"}function finishDrawComponent(cmpRank,componentNodeCount,componentEdgeCount,clustersInComponent,mode,counts){updateCurrCompInfo(cmpRank,componentNodeCount,componentEdgeCount,mode,counts);if(mode!=="SPQR"){initClusters()}cy.endBatch();cy.fit();cy.batch(function(){removeBoundingBoxEnforcingNodes()});cy.minZoom(cy.zoom());updateTextStatus("Preparing interface...",false);window.setTimeout(function(){if(isObjectNonempty(SCAFFOLDID2NODEKEYS)){updateScaffoldsInComponentList()}$("#componentselector").prop("disabled",false);enableButton("decrCompRankButton");enableButton("incrCompRankButton");enableButton("drawButton");$("#SPQRcomponentselector").prop("disabled",false);enableButton("decrSPQRCompRankButton");enableButton("incrSPQRCompRankButton");enableButton("drawSPQRButton");enableButton("implicitSPQROption");enableButton("explicitSPQROption");enableButton("fileselectButton");enableButton("loadDBbutton");enableButton("xmlFileselectButton");$("#searchInput").prop("disabled",false);$("#layoutInput").prop("disabled",false);if(componentEdgeCount>0){enableButton("reduceEdgesButton");if(ASM_FILETYPE==="LastGraph"||ASM_FILETYPE==="GML"){enableButton("filterEdgesButton")}}enableButton("layoutButton");enableButton("scaffoldFileselectButton");enableButton("startFinishingButton");enableButton("agpOption");enableButton("csvOption");enableButton("searchButton");enableButton("fitButton");enableButton("exportImageButton");enableButton("floatingExportButton");enableButton("dir0");enableButton("dir90");enableButton("dir180");enableButton("dir270");enableButton("pngOption");enableButton("jpgOption");if(DNA_AVAILABLE||REPEAT_INFO_AVAILABLE){enableButton("changeNodeColorizationButton");enableInlineRadio("noneColorization");if(DNA_AVAILABLE){enableInlineRadio("gcColorization")}if(REPEAT_INFO_AVAILABLE){enableInlineRadio("repeatColorization")}}enableButton("settingsButton");cy.userPanningEnabled(true);cy.userZoomingEnabled(true);cy.boxSelectionEnabled(true);cy.autounselectify(false);cy.autoungrabify(false);if(clustersInComponent){enableButton("collapseButton");if(mode!=="SPQR"&&USE_CLUSTER_KBD_NAV){$(document).on("keydown",moveThroughClusters)}}else{disableButton("collapseButton")}updateTextStatus("&nbsp;",false);finishProgressBar();endDrawDate=new Date;var drawTime=endDrawDate.getTime()-startDrawDate.getTime();console.log("Drawing took "+drawTime+"ms")},0)}function isObjectNonempty(object){for(var k in object){return true}return false}function closeDB(){if(CURR_DB!==null){CURR_DB.close()}}function changeDropdownVal(arrowHTML){$("#rotationDropdown").html(arrowHTML+" <span class='caret'></span>")}function toggleControls(){$("#controls").toggleClass("notviewable");$("#cy").toggleClass("nosubsume");$("#cy").toggleClass("subsume");if(cy!==null){cy.resize()}}function openFileSelectDialog(){$("#fsDialog").modal()}function loadajaxDB(){closeDB();$("#fsDialog").modal("hide");disableVolatileControls();$("#selectedNodeBadge").text(0);$("#selectedEdgeBadge").text(0);$("#selectedClusterBadge").text(0);disableButton("infoButton");$("#currComponentInfo").html("No connected component has been drawn yet.");var filename=$("input[name=fs]:checked").attr("id");DB_FILENAME=filename;var xhr=new XMLHttpRequest;xhr.open("GET",filename,true);xhr.responseType="arraybuffer";xhr.onload=function(eve){if(this.status===200){loadDBfile(this.response)}};startIndeterminateProgressBar();xhr.send()}function updateProgressBar(percentage){$(".progress-bar").css("width",percentage+"%");$(".progress-bar").attr("aria-valuenow",percentage)}function finishProgressBar(){updateProgressBar(100);if(!$(".progress-bar").hasClass("notransitions")){$(".progress-bar").addClass("notransitions")}if($(".progress-bar").hasClass("progress-bar-striped")){$(".progress-bar").removeClass("progress-bar-striped")}if($(".progress-bar").hasClass("active")){$(".progress-bar").removeClass("active")}}function startIndeterminateProgressBar(){if($("#useProgressBarStripesCheckbox").prop("checked")){$(".progress-bar").addClass("active");$(".progress-bar").addClass("progress-bar-striped");$(".progress-bar").removeClass("notransitions")}}function invertColorSettings(){$(".colorpicker-component").each(function(i){var oldRGB=$(this).data("colorpicker").color.toRGB();var newRGB="rgb("+(255-oldRGB["r"])+","+(255-oldRGB["g"])+","+(255-oldRGB["b"])+")";$(this).colorpicker("setValue",newRGB)})}function exportColorSettings(toDownload){var textToExport="";$(".colorpicker-component").each(function(i){textToExport+=this.id+"\t"+$(this).colorpicker("getValue")+"\n"});if(toDownload){downloadDataURI("color_settings.tsv",textToExport,true)}else{return textToExport}}function resetColorSettings(){integrateColorSettings(DEFAULT_COLOR_SETTINGS)}function integrateColorSettings(fileText){var fileLines=fileText.split("\n");for(var n=0;n<fileLines.length;n++){var lineVals=fileLines[n].split("\t");if(lineVals.length!==2){continue}$("#"+lineVals[0]).colorpicker("setValue",lineVals[1])}}function importColorSettings(){var csfr=new FileReader;var inputfile=document.getElementById("colorSettingsFS").files[0];if(inputfile===undefined){return}if(inputfile.name.toLowerCase().endsWith(".tsv")){csfr.onload=function(e){if(e.target.readyState===FileReader.DONE){var fileText=e.target.result;integrateColorSettings(fileText);document.getElementById("colorSettingsFS").value=""}};csfr.readAsText(inputfile)}else{alert("Please select a valid .tsv color settings file to load.")}}function downloadDataURI(filename,contentToDownload,isPlainText){$("#downloadHelper").attr("download",filename);if(isPlainText){var data="data:text/plain;charset=utf-8;base64,"+window.btoa(contentToDownload);$("#downloadHelper").attr("href",data)}else{$("#downloadHelper").attr("href",contentToDownload)}document.getElementById("downloadHelper").click()}function displaySettings(){$("#settingsDialog").modal()}function displayInfo(){$("#infoDialog").modal()}function openHelp(){window.open("https://github.com/marbl/MetagenomeScope/wiki","_blank")}function toggleEleInfo(eleType){var openerID="#"+eleType+"Opener";var infoDivID="#"+eleType+"Info";if($(openerID).hasClass("glyphicon-triangle-right")){$(openerID).removeClass("glyphicon-triangle-right");$(openerID).addClass("glyphicon-triangle-bottom")}else{$(openerID).removeClass("glyphicon-triangle-bottom");$(openerID).addClass("glyphicon-triangle-right")}$(infoDivID).toggleClass("notviewable")}function clearSelectedInfo(){$("#nodeInfoTable tr.nonheader").remove();$("#edgeInfoTable tr.nonheader").remove();$("#clusterInfoTable tr.nonheader").remove();if($("#nodeOpener").hasClass("glyphicon-triangle-bottom")){toggleEleInfo("node")}if($("#edgeOpener").hasClass("glyphicon-triangle-bottom")){toggleEleInfo("edge")}if($("#clusterOpener").hasClass("glyphicon-triangle-bottom")){toggleEleInfo("cluster")}}function getSelectedNodeDNA(){var dnaStmt;var dnaSeqs="";var currDnaSeq;var seqIndex;var afterFirstSeqLine;SELECTED_NODES.each(function(e,i){dnaStmt=CURR_DB.prepare("SELECT dnafwd FROM nodes WHERE id = ?",[e.id()]);dnaStmt.step();if(i>0){dnaSeqs+="\n"}dnaSeqs+=">NODE_"+e.id()+"\n";afterFirstSeqLine=false;currDnaSeq=dnaStmt.getAsObject()["dnafwd"];for(seqIndex=0;seqIndex<currDnaSeq.length;seqIndex+=70){if(afterFirstSeqLine){dnaSeqs+="\n"}else{afterFirstSeqLine=true}dnaSeqs+=currDnaSeq.substring(seqIndex,seqIndex+70)}dnaStmt.free()});return dnaSeqs}function exportSelectedNodeDNA(){window.open("data:text/FASTA;charset=utf-8;base64,"+window.btoa(getSelectedNodeDNA()),"_blank")}function fitGraph(toSelected){startIndeterminateProgressBar();window.setTimeout(function(){if(toSelected){cy.fit(SELECTED_NODES.union(SELECTED_EDGES).union(SELECTED_CLUSTERS))}else{cy.fit()}finishProgressBar()},20)}function exportGraphView(){var imgType=$("#imgTypeButtonGroup .btn.active").attr("value");if(imgType==="PNG"){downloadDataURI("screenshot.png",cy.png({bg:BG_COLOR}),false)}else{downloadDataURI("screenshot.jpg",cy.jpg({bg:BG_COLOR}),false)}}function openEdgeFilteringDialog(){$("#edgeFilteringDialog").modal();drawEdgeWeightHistogram()}function drawEdgeWeightHistogram(){var formatCount=d3.format(",.0f");var max=d3.max(COMPONENT_EDGE_WEIGHTS);var margin={top:10,right:30,bottom:50,left:70};d3.select("#edgeWeightChart *").remove();var chartSvg=d3.select("#edgeWeightChart");var width=+chartSvg.attr("width")-margin.left-margin.right;var height=+chartSvg.attr("height")-margin.top-margin.bottom;var g=chartSvg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");var x=d3.scaleLinear().domain([0,max*1.1]).rangeRound([0,width]);var bin_count=+$("#binCountInput").val();var bins=d3.histogram().domain(x.domain()).thresholds(x.ticks(bin_count))(COMPONENT_EDGE_WEIGHTS);var y=d3.scaleLinear().domain([0,d3.max(bins,function(b){return b.length})]).range([height,0]);var bar=g.selectAll(".edge_chart_bar").data(bins).enter().append("g").attr("class","edge_chart_bar").attr("transform",function(b){return"translate("+x(b.x0)+","+y(b.length)+")"});bar.append("rect").attr("x",1).attr("width",function(d){return x(d.x1)-x(d.x0)-1}).attr("height",function(d){return height-y(d.length)});var xAxis=d3.axisBottom(x);var yAxis=d3.axisLeft(y);g.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+height+")").call(xAxis);g.append("g").attr("class","axis axis--y").call(yAxis);g.append("text").attr("transform","translate("+width/2+","+(height+margin.top+30)+")").style("text-anchor","middle").text("Edge multiplicity");g.append("text").attr("transform","rotate(-90)").attr("y",0-margin.left).attr("x",0-height/2).attr("dy","1em").style("text-anchor","middle").text("Frequency")}function cullEdges(){var strVal=$("#cullEdgesInput").val();if(strVal.match(INTEGER_RE)===null){alert("Please enter a valid minimum edge weight (a nonnegative "+"integer) using the input field.");return}var threshold=parseInt(strVal);if(PREV_EDGE_WEIGHT_THRESHOLD!==threshold){cy.startBatch();var restoredEdges=cy.collection();REMOVED_EDGES.each(function(e,i){if(e.data("multiplicity")>=threshold){if(e.source().removed()){e.removeClass("unbundledbezier");e.addClass("basicbezier");e.move({source:e.source().data("parent")})}if(e.target().removed()){e.removeClass("unbundledbezier");e.addClass("basicbezier");e.move({target:e.target().data("parent")})}e.restore();restoredEdges=restoredEdges.union(e)}});REMOVED_EDGES=REMOVED_EDGES.difference(restoredEdges);cy.$("edge").each(function(e,i){var mult=e.data("multiplicity");if(mult!==null&&mult<threshold){if(e.selected())e.unselect();REMOVED_EDGES=REMOVED_EDGES.union(e.remove())}});cy.endBatch();PREV_EDGE_WEIGHT_THRESHOLD=threshold}}function beginLoadAGPfile(){var sfr=new FileReader;COMPONENT_HAS_SCAFFOLDS=false;var inputfile=document.getElementById("scaffoldFileSelector").files[0];if(inputfile===undefined){return}if(inputfile.name.toLowerCase().endsWith(".agp")){startIndeterminateProgressBar();SCAFFOLDID2NODEKEYS={};$("#scaffoldInfoHeader").addClass("notviewable");$("#scaffoldCycler").addClass("notviewable");sfr.nextStartPosition=0;sfr.partialLine="";sfr.readingFinalBlob=false;sfr.onload=function(e){if(e.target.readyState===FileReader.DONE){var blobText=e.target.result;var blobLines=blobText.split("\n");var c;if(blobLines.length>1){c=integrateAGPline(sfr.partialLine+blobLines[0]);if(c!==0){clearScaffoldFS(true);return}sfr.partialLine="";for(var i=1;i<blobLines.length-1;i++){c=integrateAGPline(blobLines[i]);if(c!==0){clearScaffoldFS(true);return}}if(sfr.readingFinalBlob){c=integrateAGPline(blobLines[blobLines.length-1]);if(c!==0){clearScaffoldFS(true);return}}else{sfr.partialLine=blobLines[blobLines.length-1]}}else if(blobLines.length===1){if(sfr.readingFinalBlob){c=integrateAGPline(sfr.partialLine+blobText);if(c!==0){clearScaffoldFS(true);return}}else{sfr.partialLine+=blobText}}loadAGPfile(this,inputfile,this.nextStartPosition)}};$("#agpLoadedFileName").addClass("notviewable");window.setTimeout(function(){loadAGPfile(sfr,inputfile,0)},50)}else{alert("Please select a valid AGP file to load.")}}function integrateAGPline(lineText){if(lineText!=""&&lineText[0]!=="#"){var lineColumns=lineText.split("\t");var scaffoldID=lineColumns[0];var contigKey=lineColumns[5];if(contigKey===undefined){alert("Invalid line in input AGP file: \n"+lineText);return-1}if(contigKey.startsWith("NODE")){contigKey="NODE_"+contigKey.split("_")[1]}if(SCAFFOLDID2NODEKEYS[scaffoldID]===undefined){SCAFFOLDID2NODEKEYS[scaffoldID]=[contigKey];if(COMPONENT_NODE_KEYS.indexOf(contigKey)!==-1){addScaffoldListGroupItem(scaffoldID)}}else{SCAFFOLDID2NODEKEYS[scaffoldID].push(contigKey)}}return 0}function addScaffoldListGroupItem(scaffoldID){if(!COMPONENT_HAS_SCAFFOLDS){COMPONENT_HAS_SCAFFOLDS=true;COMPONENT_SCAFFOLDS=[];$("#drawScaffoldButton").text(scaffoldID);SCAFFOLD_CYCLER_CURR_INDEX=0;$("#scaffoldCycler").removeClass("notviewable")}COMPONENT_SCAFFOLDS.push(scaffoldID)}function updateScaffoldsInComponentList(){for(var s in SCAFFOLDID2NODEKEYS){if(COMPONENT_NODE_KEYS.indexOf(SCAFFOLDID2NODEKEYS[s][0])!==-1){addScaffoldListGroupItem(s)}}updateScaffoldInfoHeader(false)}function loadAGPfile(fileReader,file,filePosition){if(filePosition<=file.size){var endPosition=filePosition+BLOB_SIZE;var currentBlob=file.slice(filePosition,endPosition);if(endPosition>file.size){fileReader.readingFinalBlob=true}fileReader.nextStartPosition=endPosition;fileReader.readAsText(currentBlob)}else{updateScaffoldInfoHeader(true)}}function updateScaffoldInfoHeader(agpFileJustLoaded){if(COMPONENT_HAS_SCAFFOLDS){$("#scaffoldInfoHeader").html("Scaffolds in Connected Component<br/>"+"(Click to highlight in graph)")}else{$("#scaffoldInfoHeader").html("No scaffolds apply to the contigs "+"in this connected component.")}$("#scaffoldInfoHeader").removeClass("notviewable");if(agpFileJustLoaded){$("#agpLoadedFileName").html(document.getElementById("scaffoldFileSelector").files[0].name);$("#agpLoadedFileName").removeClass("notviewable");clearScaffoldFS(false)}}function clearScaffoldFS(errorOnAGPload){if(errorOnAGPload){SCAFFOLDID2NODEKEYS={};COMPONENT_HAS_SCAFFOLDS=false;COMPONENT_SCAFFOLDS=[];$("#scaffoldCycler").addClass("notviewable")}document.getElementById("scaffoldFileSelector").value="";finishProgressBar()}function cycleScaffoldsLeft(){if(SCAFFOLD_CYCLER_CURR_INDEX===0){SCAFFOLD_CYCLER_CURR_INDEX=COMPONENT_SCAFFOLDS.length-1}else{SCAFFOLD_CYCLER_CURR_INDEX--}updateDrawScaffoldButtonText()}function cycleScaffoldsRight(){if(SCAFFOLD_CYCLER_CURR_INDEX===COMPONENT_SCAFFOLDS.length-1){SCAFFOLD_CYCLER_CURR_INDEX=0}else{SCAFFOLD_CYCLER_CURR_INDEX++}updateDrawScaffoldButtonText()}function updateDrawScaffoldButtonText(){var newScaffoldID=COMPONENT_SCAFFOLDS[SCAFFOLD_CYCLER_CURR_INDEX];$("#drawScaffoldButton").text(newScaffoldID);highlightScaffold(newScaffoldID)}function highlightScaffold(scaffoldID){cy.filter(":selected").unselect();var contigKeys=SCAFFOLDID2NODEKEYS[scaffoldID];var nodesToHighlight=cy.collection();var nodeToAdd;var prefix;for(var i=0;i<contigKeys.length;i++){if(ASM_FILETYPE==="GML"){prefix=contigKeys[i][0];if(prefix==="B"||prefix==="F"||prefix==="C"||prefix==="Y"){nodeToAdd=cy.getElementById(contigKeys[i])}else{nodeToAdd=cy.filter('[label="'+contigKeys[i]+'"]')}}else{nodeToAdd=cy.getElementById(contigKeys[i])}if(nodeToAdd.empty()){nodeToAdd=cy.getElementById(cy.scratch("_ele2parent")[contigKeys[i]]);if(nodeToAdd.empty()){var keyType="ID ";if(ASM_FILETYPE==="GML"){keyType="label "}alert("Node with "+keyType+contigKeys[i]+' in scaffold "'+scaffoldID+'"'+" is not present in the currently drawn connected"+" component. This scaffold is invalid.");return}}nodesToHighlight=nodesToHighlight.union(nodeToAdd)}nodesToHighlight.select()}function addNodeFromEventToPath(e){var node=e.target;if(!(node.hasClass("cluster")&&!node.data("isCollapsed"))){var nodeID=node.id();if(FINISHING_NODE_IDS.length>0){if(NEXT_NODES.is("#"+nodeID)){cy.startBatch();NEXT_NODES.removeClass("tentative");cy.endBatch()}else{return}}NEXT_NODES=node.outgoers("node");if(node.hasClass("Y")){NEXT_NODES=NEXT_NODES.union(node)}var size=NEXT_NODES.size();var reachedCycleInAutofinishing=false;if(size===1&&NEXT_NODES[0].id()!==nodeID){var autofinishingSeenNodeIDs=[];while(size===1){if(FINISHING_NODE_OBJS.length>0){$("#assembledNodes").append(", "+nodeID);FINISHING_NODE_IDS+=","+nodeID}else{$("#assembledNodes").append(nodeID);FINISHING_NODE_IDS+=nodeID}node.addClass("currpath");FINISHING_NODE_OBJS.push(node);autofinishingSeenNodeIDs.push(nodeID);node=NEXT_NODES[0];nodeID=node.id();if(autofinishingSeenNodeIDs.indexOf(nodeID)!==-1){reachedCycleInAutofinishing=true;break}NEXT_NODES=node.outgoers("node");if(node.hasClass("Y")){NEXT_NODES=NEXT_NODES.union(node)}size=NEXT_NODES.size()}}if(reachedCycleInAutofinishing){markTentativeNodes();return}if(FINISHING_NODE_OBJS.length>0){$("#assembledNodes").append(", "+nodeID);FINISHING_NODE_IDS+=","+nodeID}else{$("#assembledNodes").append(nodeID);FINISHING_NODE_IDS+=nodeID}node.addClass("currpath");FINISHING_NODE_OBJS.push(node);if(size===0){endFinishing()}else{markTentativeNodes()}}}function markTentativeNodes(){cy.startBatch();NEXT_NODES.addClass("tentative");cy.endBatch();if($("#animateFinishingCheckbox").prop("checked")){cy.maxZoom(MAX_ZOOM_DURING_FINISHING_ANIMATION);cy.animate({fit:{eles:NEXT_NODES},complete:resetMaxZoom})}}function resetMaxZoom(){cy.maxZoom(MAX_ZOOM_ORDINARY)}function startFinishing(){if(!FINISHING_MODE_ON){disableButton("startFinishingButton");if(FINISHING_MODE_PREVIOUSLY_DONE){FINISHING_NODE_IDS="";FINISHING_NODE_OBJS=[];$("#assembledNodes").empty();disableButton("exportPathButton")}FINISHING_MODE_ON=true;cy.filter(":selected").unselect();cy.autounselectify(true);cy.on("tap","node",addNodeFromEventToPath)}enableButton("endFinishingButton")}function endFinishing(){FINISHING_MODE_ON=false;FINISHING_MODE_PREVIOUSLY_DONE=true;cy.startBatch();NEXT_NODES.removeClass("tentative");for(var n=0;n<FINISHING_NODE_OBJS.length;n++){FINISHING_NODE_OBJS[n].removeClass("currpath")}cy.endBatch();NEXT_NODES=cy.collection();cy.autounselectify(false);cy.off("tap");enableButton("exportPathButton");enableButton("startFinishingButton");disableButton("endFinishingButton")}function exportPath(){var exportFileType=$("#pathExportButtonGroup .btn.active").attr("value");var textToExport="";if(exportFileType==="AGP"){var nextStartPos=1;var nextEndPos;var nodeLen,nodeOrient,nodeKey;var componentType;for(var i=0;i<FINISHING_NODE_OBJS.length;i++){nodeLen=FINISHING_NODE_OBJS[i].data("length");componentType="W";if(FINISHING_NODE_OBJS[i].hasClass("cluster")){nodeOrient="na";componentType="O"}else if(FINISHING_NODE_OBJS[i].hasClass("rightdir")){nodeOrient="+"}else{nodeOrient="-"}if(componentType==="W"&&ASM_FILETYPE==="GML"){nodeKey=FINISHING_NODE_OBJS[i].data("label")}else{nodeKey=FINISHING_NODE_OBJS[i].id()}nextEndPos=nextStartPos-1+nodeLen;textToExport+="scaffold_1\t"+nextStartPos+"\t"+nextEndPos+"\t"+(i+1)+"\t"+componentType+"\t"+nodeKey+"\t1\t"+nodeLen+"\t"+nodeOrient+"\n";nextStartPos=nextEndPos+1}downloadDataURI("path.agp",textToExport,true)}else{textToExport=FINISHING_NODE_IDS;downloadDataURI("path.csv",textToExport,true)}}function startChangeNodeColorization(){var newColorization=$("#nodeColorizationRadioButtonGroup input:checked").attr("value");if(newColorization!==CURR_NODE_COLORIZATION){startIndeterminateProgressBar();window.setTimeout(function(){changeNodeColorization(newColorization);finishProgressBar()},50)}}function changeNodeColorization(newColorization){cy.startBatch();cy.filter("node.noncluster").removeClass(CURR_NODE_COLORIZATION).addClass(newColorization);cy.scratch("_collapsed").each(function(nodeGroup,i){nodeGroup.scratch("_interiorNodes").removeClass(CURR_NODE_COLORIZATION).addClass(newColorization)});CURR_NODE_COLORIZATION=newColorization;cy.endBatch()}function getNodeColorization(gc){var percentageUsedInColorization=gc;var red_i=gc*(MAX_RGB["r"]-MIN_RGB["r"])+MIN_RGB["r"];var green_i=gc*(MAX_RGB["g"]-MIN_RGB["g"])+MIN_RGB["g"];var blue_i=gc*(MAX_RGB["b"]-MIN_RGB["b"])+MIN_RGB["b"];var red=Math.round(red_i).toString(16);var green=Math.round(green_i).toString(16);var blue=Math.round(blue_i).toString(16);var channels=[red,green,blue];for(var ch=0;ch<3;ch++){if(channels[ch].length===1){channels[ch]="0"+channels[ch]}}return"#"+channels[0]+channels[1]+channels[2]}function redrawGradientPreview(hexColor,minOrMax){var tmpColor;if(minOrMax===-1){$("#0gp").css("background-color",hexColor);MIN_RGB=$("#mincncp").data("colorpicker").color.toRGB();MIN_HEX=hexColor;if(MAX_RGB===undefined){tmpColor=$("#maxcncp").data("colorpicker").color;MAX_RGB=tmpColor.toRGB();MAX_HEX=tmpColor.toHex()}}else{$("#100gp").css("background-color",hexColor);MAX_RGB=$("#maxcncp").data("colorpicker").color.toRGB();MAX_HEX=hexColor;if(MIN_RGB===undefined){tmpColor=$("#mincncp").data("colorpicker").color;MIN_RGB=tmpColor.toRGB();MIN_HEX=tmpColor.toHex()}}$("#25gp").css("background-color",getNodeColorization(.25));$("#50gp").css("background-color",getNodeColorization(.5));$("#75gp").css("background-color",getNodeColorization(.75))}function testLayout(){if($("#layoutInput").val()!==""){startIndeterminateProgressBar();cy.minZoom(0);window.setTimeout(function(){reduceEdgesToStraightLines(false);cy.layout({name:$("#layoutInput").val(),fit:true,padding:0,stop:function(){finishProgressBar()}}).run()},20)}}function reduceEdgesToStraightLines(useProgressBar){if(useProgressBar){startIndeterminateProgressBar();window.setTimeout(function(){doReduceEdges();finishProgressBar()},50)}else{doReduceEdges()}}function doReduceEdges(){cy.startBatch();cy.filter("edge").each(function(e,i){e.removeClass("unbundledbezier");e.addClass("reducededge");e.addClass("basicbezier")});cy.endBatch()}function searchForEles(){var nameText=$("#searchInput").val();if(nameText.trim()===""){alert("Error -- please enter element name(s) to search for.");return}var names=nameText.split(",");var eles=cy.collection();var newEle;var parentID;var queriedName;for(var c=0;c<names.length;c++){queriedName=names[c].trim();if(queriedName.startsWith("contig")||queriedName.startsWith("NODE"))newEle=cy.filter('[label="'+queriedName+'"]');else newEle=cy.getElementById(queriedName);if(newEle.empty()){parentID=cy.scratch("_ele2parent")[queriedName];if(parentID!==undefined){eles=eles.union(cy.getElementById(parentID))}else{alert("Error -- element ID/label "+queriedName+" is not in this component.");return}}else{eles=eles.union(newEle)}}cy.fit(eles);cy.filter(":selected").unselect();eles.select()}function uncollapseSPQRMetanode(mn){var mnID=mn.id();var outgoingEdgesStmt=CURR_DB.prepare("SELECT * FROM metanodeedges WHERE source_metanode_id = ?",[mnID]);var outgoingEdgeObjects=[];var descendantMetanodeIDs=[];var descendantMetanodeQMs="(";var edgeObj;while(outgoingEdgesStmt.step()){edgeObj=outgoingEdgesStmt.getAsObject();outgoingEdgeObjects.push(edgeObj);descendantMetanodeIDs.push(edgeObj["target_metanode_id"]);descendantMetanodeQMs+="?,"}outgoingEdgesStmt.free();mn.scratch("_descendantMetanodeIDs",descendantMetanodeIDs);descendantMetanodeQMs=descendantMetanodeQMs.slice(0,descendantMetanodeQMs.length-1)+")";var descendantMetanodesStmt=CURR_DB.prepare("SELECT * FROM metanodes WHERE metanode_id IN "+descendantMetanodeQMs,descendantMetanodeIDs);var descendantMetanodeObjects=[];while(descendantMetanodesStmt.step()){descendantMetanodeObjects.push(descendantMetanodesStmt.getAsObject())}descendantMetanodesStmt.free();var singlenodesStmt=CURR_DB.prepare("SELECT * FROM singlenodes WHERE parent_metanode_id IN"+descendantMetanodeQMs,descendantMetanodeIDs);var singlenodeObjects=[];while(singlenodesStmt.step()){singlenodeObjects.push(singlenodesStmt.getAsObject())}singlenodesStmt.free();var singleedgesStmt=CURR_DB.prepare("SELECT * FROM singleedges WHERE parent_metanode_id IN"+descendantMetanodeQMs,descendantMetanodeIDs);var singleedgeObjects=[];while(singleedgesStmt.step()){singleedgeObjects.push(singleedgesStmt.getAsObject())}singleedgesStmt.free();var a,b;var sourcePos=mn.position();var descendantID2pos={};descendantID2pos[mnID]=[sourcePos["x"],sourcePos["y"]];var clusterIDandPos=[];for(a=0;a<descendantMetanodeObjects.length;a++){if(CURR_SPQRMODE==="explicit"||descendantMetanodeObjects[a]["descendant_metanode_count"]>0){clusterIDandPos=renderClusterObject(descendantMetanodeObjects[a],CURR_BOUNDINGBOX,"metanode");descendantID2pos[clusterIDandPos[0]]=clusterIDandPos[1]}}if(CURR_SPQRMODE==="explicit"){for(a=0;a<outgoingEdgeObjects.length;a++){renderEdgeObject(outgoingEdgeObjects[a],descendantID2pos,CURR_BOUNDINGBOX,"metanodeedge","SPQR",{})}}var cyNodeID,normalID,parentBicmpID;var currIDs;var alreadyVisible;var singlenodeMapping={};for(a=0;a<singlenodeObjects.length;a++){normalID=singlenodeObjects[a]["id"];if(CURR_SPQRMODE==="implicit"){parentBicmpID=singlenodeObjects[a]["parent_bicomponent_id"];currIDs=BICOMPONENTID2VISIBLESINGLENODEIDS[parentBicmpID];alreadyVisible=false;for(b=0;b<currIDs.length;b++){if(normalID===currIDs[b].split("_")[0]){alreadyVisible=true;singlenodeMapping[normalID]=currIDs[b];break}}if(alreadyVisible){continue}}cyNodeID=normalID+"_"+singlenodeObjects[a]["parent_metanode_id"];renderNodeObject(singlenodeObjects[a],cyNodeID,CURR_BOUNDINGBOX,"SPQR")}for(a=0;a<singleedgeObjects.length;a++){renderEdgeObject(singleedgeObjects[a],{},CURR_BOUNDINGBOX,"singleedge","SPQR",singlenodeMapping)}if(CURR_SPQRMODE==="explicit"){mn.data("isCollapsed",false)}else{var edgesToRemove=mn.scratch("_virtualedgeIDs");var edgeToRemove;for(var c=0;c<edgesToRemove.length;c++){edgeToRemove=cy.getElementById(edgesToRemove[c]);edgeToRemove.unselect();edgeToRemove.remove()}mn.unselect();mn.remove()}}function collapseSPQRMetanode(mn){var a,b;var descendantMetanodeIDs=mn.scratch("_descendantMetanodeIDs");var mn2;var singlenodeIDs;for(a=0;a<descendantMetanodeIDs.length;a++){mn2=cy.getElementById(descendantMetanodeIDs[a]);if(mn2.data("descendantCount")>0&&!mn2.data("isCollapsed")){collapseSPQRMetanode(mn2)}singlenodeIDs=mn2.scratch("_singlenodeIDs");var nodeToRemove;for(b=0;b<singlenodeIDs.length;b++){nodeToRemove=cy.getElementById(singlenodeIDs[b]);nodeToRemove.unselect();nodeToRemove.connectedEdges().unselect();nodeToRemove.remove()}mn2.unselect();mn2.remove()}mn.data("isCollapsed",true)}function startCollapseAll(){if(CURR_VIEWTYPE!=="SPQR"){var currVal=$("#collapseButtonText").text();startIndeterminateProgressBar();window.setTimeout(function(){collapseAll(currVal[0])},50)}}function collapseAll(operationCharacter){cy.startBatch();if(operationCharacter==="U"){cy.scratch("_collapsed").each(function(cluster,i){uncollapseCluster(cluster)})}else{cy.scratch("_uncollapsed").each(function(cluster,i){collapseCluster(cluster)})}finishProgressBar();cy.endBatch()}function degreesToRadians(angle){return angle*(Math.PI/180)}function rotateCoordinate(xCoord,yCoord){var rotation=PREV_ROTATION-CURR_ROTATION;if(rotation%360===0){return[xCoord,yCoord]}else{var newX=xCoord*Math.cos(degreesToRadians(rotation))-yCoord*Math.sin(degreesToRadians(rotation));var newY=yCoord*Math.cos(degreesToRadians(rotation))+xCoord*Math.sin(degreesToRadians(rotation));newX=parseFloat(newX.toFixed(2));newY=parseFloat(newY.toFixed(2));return[newX,newY]}}function gv2cyPoint(xCoord,yCoord,boundingbox){var cyY=boundingbox[1]-yCoord;var cyX=xCoord;return rotateCoordinate(cyX,cyY)}function ctrlPtStrToList(ctrlPointStr,boundingbox){var coordList=ctrlPointStr.trim().split(" ");var clLen=coordList.length;if(clLen%2!==0){return null}else{var pointList=[];var currPoint=[];for(var i=0;i<clLen;i++){if(i%2===0){pointList[i/2]=gv2cyPoint(parseFloat(coordList[i]),parseFloat(coordList[i+1]),boundingbox)}}return pointList}}function initNodeAdjacents(){cy.filter("node.noncluster").each(function(node,i){node.data("adjacentEdges",node.incomers("edge").union(node.outgoers("edge")))})}function initClusters(){cy.scratch("_uncollapsed").each(function(node,i){var children=node.children();var uIncomingEdges=children.incomers("edge");var uOutgoingEdges=children.outgoers("edge");var incomingEdges=uIncomingEdges.difference(uOutgoingEdges);var outgoingEdges=uOutgoingEdges.difference(uIncomingEdges);var incomingEdgeMap={};var outgoingEdgeMap={};incomingEdges.each(function(edge,j){incomingEdgeMap[edge.id()]=[edge.source().id(),edge.target().id()]});outgoingEdges.each(function(edge,j){outgoingEdgeMap[edge.id()]=[edge.source().id(),edge.target().id()]});var interiorEdges=children.connectedEdges().difference(incomingEdges).difference(outgoingEdges);node.data({incomingEdgeMap:incomingEdgeMap,outgoingEdgeMap:outgoingEdgeMap,interiorNodeCount:children.size(),w:node.scratch("_w"),h:node.scratch("_h")});node.removeScratch("_w");node.removeScratch("_h");node.scratch({_interiorEles:interiorEdges.union(children),_interiorNodes:children})});CLUSTERID2TOP.sort(function(c1,c2){return c2.t-c1.t})}function getClusterCoordClass(){if(CURR_ROTATION===0||CURR_ROTATION===180){return"updowndir"}else{return"leftrightdir"}}function getNodeCoordClass(isHouse){switch(CURR_ROTATION){case 0:return isHouse?"updir":"downdir";case 90:return isHouse?"leftdir":"rightdir";case 180:return isHouse?"downdir":"updir";case 270:return isHouse?"rightdir":"leftdir"}}function renderNodeObject(nodeObj,cyNodeID,boundingboxObject,mode){var nx,ny;if(mode==="SPQR"&&CURR_SPQRMODE==="implicit"){nx=nodeObj["i_x"];ny=nodeObj["i_y"]}else{nx=nodeObj["x"];ny=nodeObj["y"]}var pos=gv2cyPoint(nx,ny,[boundingboxObject["boundingbox_x"],boundingboxObject["boundingbox_y"]]);var nodeShapeClass="singlenode";if(mode!=="SPQR"){nodeShapeClass=getNodeCoordClass(nodeObj["shape"]==="house")}var nodeLabel=nodeObj["label"];var labelUsed;if(ASM_FILETYPE==="GML"){if(nodeLabel!==null&&nodeLabel!==undefined){COMPONENT_NODE_KEYS.push(nodeLabel);labelUsed=nodeLabel}else{labelUsed=nodeObj["id"]}}else{COMPONENT_NODE_KEYS.push(nodeObj["id"]);labelUsed=nodeObj["id"]}var parentID;var parentBicmpID=null;var nodeDepth=null;var nodeLength=null;var nodeGC=null;var nodeIsRepeat=null;if(mode==="SPQR"){parentID=nodeObj["parent_metanode_id"];if(CURR_SPQRMODE==="implicit"){parentBicmpID=nodeObj["parent_bicomponent_id"];if(parentBicmpID!==null&&parentBicmpID!==undefined){BICOMPONENTID2VISIBLESINGLENODEIDS[parentBicmpID].push(cyNodeID)}}}else{parentID=nodeObj["parent_cluster_id"]}nodeDepth=nodeObj["depth"];nodeLength=nodeObj["length"];nodeGC=nodeObj["gc_content"];nodeIsRepeat=nodeObj["is_repeat"];var gcColor=null;if(nodeGC!==null){gcColor=getNodeColorization(nodeGC)}var repeatColor=null;if(nodeIsRepeat!==undefined){if(nodeIsRepeat===null){repeatColor=DEFAULT_NODE_COLOR}else{if(nodeIsRepeat===1){repeatColor=MAX_HEX}else{repeatColor=MIN_HEX}}}var nodeData={id:cyNodeID,label:labelUsed,w:INCHES_TO_PIXELS*nodeObj["h"],h:INCHES_TO_PIXELS*nodeObj["w"],depth:nodeDepth,length:nodeLength,gc_content:nodeGC,gc_color:gcColor,repeat_color:repeatColor,is_repeat:nodeIsRepeat};if(parentID!==null){var typeTag=parentID[0];if(typeTag!=="S"&&typeTag!=="P"&&typeTag!=="R"&&typeTag!=="I"){nodeData["parent"]=parentID}else{if(CURR_SPQRMODE==="explicit"){cy.getElementById(parentID).scratch("_singlenodeIDs").push(cyNodeID)}}cy.scratch("_ele2parent")[cyNodeID]=parentID;if(nodeLabel!==null)cy.scratch("_ele2parent")[nodeLabel]=parentID}cy.add({classes:"noncluster "+CURR_NODE_COLORIZATION+" "+nodeShapeClass,data:nodeData,position:{x:pos[0],y:pos[1]}});return pos}function drawBoundingBoxEnforcingNodes(boundingboxObject){var bb=[boundingboxObject["boundingbox_x"],boundingboxObject["boundingbox_y"]];var bottomLeftPt=gv2cyPoint(0,0,bb);var topRightPt=gv2cyPoint(bb[0],bb[1],bb);cy.add({classes:"bb_enforcing",data:{id:"bottom_left"},position:{x:bottomLeftPt[0],y:bottomLeftPt[1]}});cy.add({classes:"bb_enforcing",data:{id:"top_right"},position:{x:topRightPt[0],y:topRightPt[1]}})}function removeBoundingBoxEnforcingNodes(){cy.$("node.bb_enforcing").remove()}function renderClusterObject(clusterObj,boundingboxObject,spqrtype){var clusterID;var parent_bicmp_id=null;var spqrRelated=false;if(spqrtype==="bicomponent"){clusterID="I"+clusterObj["id_num"];spqrRelated=true}else if(spqrtype==="metanode"){clusterID=clusterObj["metanode_id"];parent_bicmp_id="I"+clusterObj["parent_bicomponent_id_num"];spqrRelated=true}else{clusterID=clusterObj["cluster_id"];CLUSTERID2TOP.push({id:clusterID,t:clusterObj["top"]})}var l="left";var b="bottom";var r="right";var t="top";if(spqrRelated&&CURR_SPQRMODE==="implicit"){l="i_"+l;b="i_"+b;r="i_"+r;t="i_"+t}var bottomLeftPos=gv2cyPoint(clusterObj[l],clusterObj[b],[boundingboxObject["boundingbox_x"],boundingboxObject["boundingbox_y"]]);var topRightPos=gv2cyPoint(clusterObj[r],clusterObj[t],[boundingboxObject["boundingbox_x"],boundingboxObject["boundingbox_y"]]);var clusterData={id:clusterID,w:Math.abs(topRightPos[0]-bottomLeftPos[0]),h:Math.abs(topRightPos[1]-bottomLeftPos[1]),isCollapsed:false};if(parent_bicmp_id!==null&&CURR_SPQRMODE==="explicit"){clusterData["parent"]=parent_bicmp_id}var pos=[(bottomLeftPos[0]+topRightPos[0])/2,(bottomLeftPos[1]+topRightPos[1])/2];var abbrev=clusterID[0];var classes=abbrev+" cluster "+getClusterCoordClass();if(!spqrRelated){classes+=" structuralPattern";COMPONENT_NODE_KEYS.push(clusterID);clusterData["length"]=clusterObj["length"];if(abbrev==="M"){clusterData["cluster_type"]=clusterObj["cluster_type"]}}else if(spqrtype==="metanode"){classes+=" spqrMetanode";clusterData["descendantCount"]=clusterObj["descendant_metanode_count"];clusterData["isCollapsed"]=true}if(spqrRelated){classes+=" pseudoparent";if(CURR_SPQRMODE==="implicit"&&spqrtype==="bicomponent"){clusterData["interiorNodeCount"]="N/A"}else{clusterData["interiorNodeCount"]=clusterObj["node_count"]}}var newObj=cy.add({classes:classes,data:clusterData,position:{x:pos[0],y:pos[1]},locked:spqrRelated});if(spqrtype==="metanode"){if(CURR_SPQRMODE==="explicit"){newObj.scratch("_singlenodeIDs",[])}else{newObj.scratch("_virtualedgeIDs",[])}}else if(spqrtype==="bicomponent"&&CURR_SPQRMODE==="implicit"){BICOMPONENTID2VISIBLESINGLENODEIDS[clusterID]=[]}else{cy.scratch("_uncollapsed",cy.scratch("_uncollapsed").union(newObj))}if(clusterObj["w"]===null||clusterObj["w"]===undefined){newObj.scratch("_w",2*INCHES_TO_PIXELS);newObj.scratch("_h",2*INCHES_TO_PIXELS)}else{newObj.scratch("_w",INCHES_TO_PIXELS*clusterObj["h"]);newObj.scratch("_h",INCHES_TO_PIXELS*clusterObj["w"])}return[clusterID,pos]}function renderEdgeObject(edgeObj,node2pos,boundingboxObject,edgeType,mode,actualIDmapping){var sourceID,targetID;if(edgeType==="metanodeedge"){sourceID=edgeObj["source_metanode_id"];targetID=edgeObj["target_metanode_id"]}else{var displaySourceID=edgeObj["source_id"];var displayTargetID=edgeObj["target_id"];sourceID=displaySourceID;targetID=displayTargetID;if(mode==="SPQR"){var edgeClasses="basicbezier";if(sourceID===targetID){edgeClasses+=" unoriented_loop"}var parent_mn_id=edgeObj["parent_metanode_id"];var isVirtual=false;if(parent_mn_id!==null){if(actualIDmapping[sourceID]!==undefined){sourceID=actualIDmapping[sourceID]}else{sourceID+="_"+parent_mn_id}if(actualIDmapping[targetID]!==undefined){targetID=actualIDmapping[targetID]}else{targetID+="_"+parent_mn_id}if(edgeObj["is_virtual"]!==0){edgeClasses+=" virtual";isVirtual=true}}var addNote=false;if(CURR_SPQRMODE==="implicit"&&isVirtual){if(cy.getElementById(parent_mn_id).empty()){return}else{addNote=true}}var e=cy.add({classes:edgeClasses,data:{source:sourceID,target:targetID,dispsrc:displaySourceID,disptgt:displayTargetID,thickness:MAX_EDGE_THICKNESS}});if(addNote){cy.getElementById(parent_mn_id).scratch("_virtualedgeIDs").push(e.id())}return}}var multiplicity,thickness,is_outlier,orientation,mean,stdev;if(mode!=="SPQR"){multiplicity=edgeObj["multiplicity"];thickness=edgeObj["thickness"];is_outlier=edgeObj["is_outlier"];orientation=edgeObj["orientation"];mean=edgeObj["mean"];stdev=edgeObj["stdev"];if(multiplicity!==undefined&&multiplicity!==null){COMPONENT_EDGE_WEIGHTS.push(+multiplicity)}}else{thickness=.5;is_outlier=0}var edgeID=sourceID+"->"+targetID;if(edgeObj["parent_cluster_id"]!==null){cy.scratch("_ele2parent")[edgeID]=edgeObj["parent_cluster_id"]}var edgeWidth=MIN_EDGE_THICKNESS+thickness*EDGE_THICKNESS_RANGE;var isOutlierClass="";if(is_outlier===1)isOutlierClass=" high_outlier";else if(is_outlier===-1)isOutlierClass=" low_outlier";if(sourceID===targetID){cy.add({classes:"basicbezier oriented"+isOutlierClass,data:{source:sourceID,target:targetID,thickness:edgeWidth,multiplicity:multiplicity,orientation:orientation,mean:mean,stdev:stdev}});return}var srcPos=node2pos[sourceID];var tgtPos=node2pos[targetID];var srcSinkDist=distance(srcPos,tgtPos);var ctrlPts=ctrlPtStrToList(edgeObj["control_point_string"],[boundingboxObject["boundingbox_x"],boundingboxObject["boundingbox_y"]]);var ctrlPtLen=edgeObj["control_point_count"];var nonzero=false;var ctrlPtDists="";var ctrlPtWeights="";var currPt,dsp,dtp,w,ws,wt,nonzero;for(var p=0;p<ctrlPtLen;p++){currPt=ctrlPts[p];var d=-pointToLineDistance(currPt,{x:srcPos[0],y:srcPos[1]},{x:tgtPos[0],y:tgtPos[1]});dsp=distance(currPt,srcPos);dtp=distance(currPt,tgtPos);ws=Math.sqrt(Math.abs(Math.pow(dsp,2)-Math.pow(d,2)));wt=Math.sqrt(Math.abs(Math.pow(dtp,2)-Math.pow(d,2)));if(wt>srcSinkDist&&wt>ws){w=-ws/srcSinkDist}else{w=ws/srcSinkDist}if(Math.abs(d)>CTRL_PT_DIST_EPSILON){nonzero=true}if(p===0&&w===0){w=.01}else if(p===ctrlPtLen-1&&w===1){w=.99}ctrlPtDists+=d.toFixed(2)+" ";ctrlPtWeights+=w.toFixed(2)+" "}ctrlPtDists=ctrlPtDists.trim();ctrlPtWeights=ctrlPtWeights.trim();var extraClasses=" oriented"+isOutlierClass;if(ASM_FILETYPE==="GML"){}if(nonzero){cy.add({classes:"unbundledbezier"+extraClasses,data:{source:sourceID,target:targetID,cpd:ctrlPtDists,cpw:ctrlPtWeights,thickness:edgeWidth,multiplicity:multiplicity,orientation:orientation,mean:mean,stdev:stdev}})}else{cy.add({classes:"basicbezier"+extraClasses,data:{source:sourceID,target:targetID,thickness:edgeWidth,multiplicity:multiplicity,orientation:orientation,mean:mean,stdev:stdev}})}}function distance(point1,point2){return Math.sqrt(Math.pow(point2[0]-point1[0],2)+Math.pow(point2[1]-point1[1],2))}function pointToLineDistance(point,lNode1,lNode2){var lDist=distance([lNode1.x,lNode1.y],[lNode2.x,lNode2.y]);if(lDist===0){return 0}var ydelta=lNode2.y-lNode1.y;var xdelta=lNode2.x-lNode1.x;var consts=lNode2.x*lNode1.y-lNode2.y*lNode1.x;var numer=ydelta*point[0]-xdelta*point[1]+consts;return numer/lDist}

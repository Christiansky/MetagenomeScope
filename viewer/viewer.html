<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="shortcut icon" href="bubble.ico" />
        <meta name="viewport"
            content="width=device-width,initial-scale=1,user-scalable=no" />
        <title>AsmViz Viewer</title>
        <!-- Load external libraries:
             -Cytoscape.js (for drawing the graph)
             -sql.js (for reading SQLite .db files)
             -jQuery (for supporting jQuery UI)
             -Bootstrap -->
        <!-- TODO, ensure we use the minified versions for release. Also use a
            customized version of Bootstrap that only supports what features we
            need -->
        <script src="https://code.jquery.com/jquery-3.1.0.min.js"
            integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="
            crossorigin="anonymous"></script>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/viewer_style.css">
        <script src='js/cytoscape.min.js'></script>
        <script src='js/sql.js'></script>
        <script src='js/xdot2cy.js'></script>
        <script src='js/bootstrap.min.js'></script>
        <!-- Initialize some event bindings for the application -->
        <script>
            $(function() {
                $(window).on("beforeunload", closeDB);
                $("input[name=rotationRadio]").on("change", changeRotation);
                // If we add any tooltips, use this line to initialize them
                //$("[data-toggle='tooltip']").tooltip();
            });
        </script>
    </head>
    <body>
        <!-- Absolutely positioned tools -->
        <div id="controlsToggler" onclick="toggleControls();" class="btn">
           <span class="glyphicon glyphicon-menu-hamburger"></span>
        </div>

        <!-- NOTE: For all Bootstrap buttons, we need to do two "layers"
             of disabling. Adding the disabled class to a button makes
             Bootstrap style the button to look disabled, but the button
             will still be usable. Adding the disabled="disabled" attribute
             makes the button actually disabled (i.e. not usable).
        
             To handle this properly, we use the enableButton and
             disableButton functions (defined in xdot2cy.js) to ensure
             buttons are always properly disabled/enabled.
        -->
        <button class='btn btn-default btn-sm disabled'
            onclick='fitGraph(false)' id="fitButton" disabled="disabled">
            <span class="glyphicon glyphicon-resize-full"></span>
        </button>

        <button class='btn btn-default btn-sm disabled'
            onclick='fitGraph(true)' id="fitSelectedButton"
            disabled="disabled">
            <span class="glyphicon glyphicon-resize-small"></span>
        </button>

        <div id="controls" class="viewable">
            <!-- TODO replace these headers with a nicer-looking system -->
            <h4 style="margin-top: 26px;">File Selection</h4>
            <p>
            <button class='btn btn-default btn-sm' id="xmlFileselectButton"
                onclick="openFileSelectDialog();">
                <span class="glyphicon glyphicon-repeat"
                    aria-hidden="true"></span> &nbsp; Demo .db
            </button>
            <button class='btn btn-default btn-sm' id="fileselectButton"
                onclick="$('#fileselector').click();">
                <span class="glyphicon glyphicon-folder-open"
                    aria-hidden="true"></span> &nbsp; Choose .db file
            </button>
            <!-- For some reason, styling this with a "hiddenElement" CSS class
                doesn't work; I suspect it's due to the way browsers handle
                styling of file inputs. Anyway, this should work fine. -->
    	    <input type='file' id='fileselector'
                onchange='loadgraphfile();' style="display: none"/>

            <button class='btn btn-default btn-sm disabled'
                disabled="disabled"
                onclick='displayInfo();' id="infoButton">
                <span class="glyphicon glyphicon-info-sign"
                    aria-hidden="true"></span> &nbsp; Assembly info
            </button>
            </p>
            <div class="progress">
                <div class="progress-bar notransitions" role="progressbar"
                     aria-valuenow="0" aria-valuemin="0"
                     aria-valuemax="100" style="width: 0%;">
                    <span class="sr-only"></span>
                </div>
            </div>
            <div id='textStatus'>&nbsp;</div>
            <hr />

            <h4>Connected Components</h4>
    
            <p>
                <div class='input-group input-group-sm'>
                    <span class='input-group-btn'>
                        <button class='btn btn-default disabled'
                            disabled="disabled" onclick='decrCompRank();'
                            type="button" id="decrCompRankButton">
                            <span class="glyphicon glyphicon-minus"
                                aria-hidden="true"
                                aria-label="Decrement component size rank by 1">
                            </span>
                        </button>
                    </span>
                    <input type='text' class='form-control'
                        id="componentselector" value="1" min="1"
                        disabled="disabled">
                    <span class='input-group-btn'>
                        <button class='btn btn-default disabled'
                            disabled="disabled" onclick='incrCompRank();'
                            type="button" id="incrCompRankButton">
                            <span class="glyphicon glyphicon-plus"
                                aria-hidden="true"
                                aria-label="Increment component size rank by 1">
                            </span>
                        </button>
                    </span>
                </div>
                <button class='btn btn-default btn-sm disabled'
                    disabled="disabled" onclick='startDrawComponent();'
                    type="button" id="drawButton">
                    <span class="glyphicon glyphicon-pencil"
                        aria-hidden="true"></span> &nbsp;
                        Draw connected component
                </button>
            </p>
            <hr /> 

            <h4>Selected Elements</h4>
            <p>
    
            <!-- Selected node info -->
            <div class="selectedEleHeader"
                    onclick="toggleEleInfo('node');">
                Nodes <span class="badge" id="selectedNodeBadge">0</span>
                <span class="glyphicon glyphicon-triangle-right opener"
                    id="nodeOpener"></span>
            </div>
            <div id="nodeInfo" class="notviewable">
                <table border="2" id="nodeInfoTable" class="infoTable">
                    <tr>
                        <th colspan='4'>Selected Node Information</th>
                    </tr>
                    <tr>
                        <th>ID</th>
                        <th>Length</th>
                        <th>Depth</th>
                        <th>G/C Content</th>
                    </tr>
                </table>
                <button class='btn btn-default btn-sm disabled'
                    disabled="disabled" onclick='exportSelectedNodeDNA();'
                    id="dnaExportButton">
                    <span class="glyphicon glyphicon-export"></span> &nbsp;
                        Export selected node DNA to FASTA
                </button>
            </div>
            <!-- Selected edge info -->
            <div class="selectedEleHeader"
                    onclick="toggleEleInfo('edge');">
                Edges <span class="badge" id="selectedEdgeBadge">0</span>
                <span class="glyphicon glyphicon-triangle-right opener"
                    id="edgeOpener"></span>
            </div>
            <div id="edgeInfo" class="notviewable">
                <table border="2" id="edgeInfoTable" class="infoTable">
                <tr>
                    <th colspan='3'>Selected Edge Information</th>
                </tr>
                <tr>
                    <th>Source ID</th>
                    <th>Target ID</th>
                    <th>Multiplicity</th>
                </tr>
                </table>
            </div>
            <!-- Selected cluster info -->
            <div class="selectedEleHeader"
                    onclick="toggleEleInfo('cluster');">
                Clusters <span class="badge" id="selectedClusterBadge">0</span>
                <span class="glyphicon glyphicon-triangle-right opener"
                    id="clusterOpener"></span>
            </div>
            <div id="clusterInfo" class="notviewable">
                <table border="2" id="clusterInfoTable" class="infoTable">
                <tr>
                    <th colspan='3'>Selected Cluster Information</th>
                </tr>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Child Count</th>
                </tr>
                </table>
            </div>

            </p>
            <hr /> 

            <h4>Search for Elements</h4>
            <div class='input-group input-group-sm'>
                <input type='text' class='form-control'
                    placeholder="Element ID(s)" id="searchInput"
                    disabled="disabled" onkeypress="searchWithEnter(event);">
                <span class='input-group-btn'>
                    <button class='btn btn-default disabled'
                        disabled="disabled"
                        onclick='searchForEles();' type="button"
                        id="searchButton" aria-label="Search">
                        <span class="glyphicon glyphicon-search"
                            aria-hidden="true"></span>
                    </button>
                </span>
            </div>
            <hr />
            <h4>Node Groups</h4>
            <!-- Value of this button will be toggled as all nodes in graph
                 are collapsed/uncollapsed -->
            <button class='btn btn-default btn-sm disabled'
                disabled="disabled"
                id='collapseButton' onclick='startCollapseAll()'>
                <span id="collapseButtonIcon"
                    class="glyphicon glyphicon-minus-sign"></span> &nbsp;
                <span id="collapseButtonText">Collapse All</span>
            </button>
            
            <hr />
            <h4>Graph Rotation</h4>
            <div class="btn-group" data-toggle="buttons"
                aria-label="Graph hierarchical rank direction"
                id="rotationButtonGroup">
                <button class="btn btn-default disabled" value="0" id="dir0"
                    disabled="disabled">
                    <input type="radio" name="rotationRadio"
                        autocomplete="off">&#8595;
                </button>
                <button class="btn btn-default active disabled" value="90"
                    id="dir90" disabled="disabled">
                    <input type="radio" name="rotationRadio" checked="checked"
                        autocomplete="off">&#8594;
                </button>
                <button class="btn btn-default disabled" value="180"
                    id="dir180" disabled="disabled">
                    <input type="radio" name="rotationRadio"
                        autocomplete="off">&#8593;
                </button>
                <button class="btn btn-default disabled" value="270"
                    id="dir270" disabled="disabled">
                    <input type="radio" name="rotationRadio"
                        autocomplete="off">&#8592;
                </button>
            </div>

            <hr />
            <h4>Export Graph View</h4>
            <button class='btn btn-default btn-sm disabled'
                disabled="disabled"
                id='exportButton' onclick='exportGraph()'>
                <span class="glyphicon glyphicon-picture"></span> &nbsp;
                Export view as PNG
            </button>

            <!-- hideEdgesOnViewport and textureOnViewport checkboxes here -->

            <div id='status'></div>
        </div> <!-- end controls div -->
        <div id="cy" class="nosubsume"></div> <!--container for Cytoscape.js-->
        <!-- XHR .db loader dialog -->
        <div class="modal fade" role="dialog" id='fsDialog'>
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close"
                            data-dismiss="modal" aria-label="Close dialog">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">
                            Select a demo assembly file
                        </h4>
                    </div> <!-- end modal-header div -->
                    <div class="modal-body">
                        <!-- modal-body stuff -->
                        <label for="ecoli.db">
                            E. coli (LastGraph [Velvet], 279 contigs,
                            332 edges)
                        </label>
                        <input type="radio" name="fs" id="ecoli.db"
                            checked="checked">
                        <br />
                        <label for="shakya.db">Bacterial/Archaeal Metagenome
                            from <a target="_blank"
                            href="http://www.ncbi.nlm.nih.gov/pubmed/23387867">
                                <em>Shakya et al.</em> 2013</a>
                            (GML [Bambus 3], 21,950 scaffolds, 23,501 edges)
                        </label>
                        <input type="radio" name="fs" id="shakya.db">
                        <br />
                        <label for="small_ecoli.db">E. coli (GML [Bambus 3],
                            168 scaffolds, 478 edges)
                        </label>
                        <input type="radio" name="fs" id="small_ecoli.db">
                        <br />
                        <label for="sample_salmonella.db">Salmonella enterica
                            (LastGraph, 61 contigs, 82 edges)
                        </label>
                        <input type="radio" name="fs" id="sample_salmonella.db">
                        <br />
                        <label for="sample_gfa.db">sample.gfa from <a
                               target="_blank"
                               href="https://github.com/sjackman/assembly-graph/blob/master/sample.gfa">Shaun Jackman</a>
                                (GFA, 6 contigs, 4 edges)
                        </label>
                        <input type="radio" name="fs" id="sample_gfa.db">
                        <br />
                        <label for="loop_gfa.db">loop.gfa from <a
                               target="_blank"
                               href="https://github.com/sjackman/assembly-graph/blob/master/loop.gfa">Shaun Jackman</a>
                                (GFA, 4 contigs, 4 edges)
                        </label>
                        <input type="radio" name="fs" id="loop_gfa.db">
                        <br />
                        <label for="longtest.db">Test graph for "long" bubbles
                            and frayed ropes (LastGraph, 36 contigs, 36 edges)
                        </label>
                        <input type="radio" name="fs" id="longtest.db">
                    </div> <!-- end modal-body div -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default"
                            data-dismiss="modal">Close
                        </button>
                        <button type="button" class="btn btn-primary"
                            id="loadDBbutton" onclick="loadajaxDB();">
                            Load selected file
                        </button>
                    </div>
                </div> <!-- end modal-content div -->
            </div> <!-- end modal-dialog div -->
        </div> <!-- end modal div -->
        <!-- Assembly info dialog -->
        <div class="modal fade" tabindex="-1" role="dialog" id='infoDialog'>
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close"
                            data-dismiss="modal" aria-label="Close dialog">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">
                            Assembly information
                        </h4>
                    </div> <!-- end modal-header div -->
                    <div class="modal-body">
                        <table border="2" class="infoTable">
                            <tr>
                                <th>Filename</th>
                                <th>Filetype</th>
                                <th>Node Count</th>
                                <th>Total Node Length</th>
                                <th>Edge Count</th>
                                <th>Connected Component Count</th>
                                <th>N50</th>
                                <th>Assembly G/C Content</th>
                            </tr>
                            <tr>
                                <td id="filenameEntry"></td>
                                <td id="filetypeEntry"></td>
                                <td id="nodeCtEntry"></td>
                                <td id="totalBPLengthEntry"></td>
                                <td id="edgeCountEntry"></td>
                                <td id="connCmpCtEntry"></td>
                                <td id="n50Entry"></td>
                                <td id="asmGCEntry"></td>
                            </tr>
                        </table>
                        <p id="currComponentInfo">
                            No connected component has been drawn yet.
                        </p>
                        <h3>For contig assembly graphs (LastGraph, GFA)</h3>
                        <p>
                            The <strong>node count</strong> and
                            <strong>edge count</strong> fields in the table
                            above (not in the percentage statistics) only
                            include "positive" contigs and their edges from
                            the assembly graph. If you would like to know
                            these statistics with negative nodes included,
                            then you can just multiply these fields by two.
                        </p>
                        <h3>For scaffold assembly graphs (GML)</h3>
                        <p>
                            All nodes are included in
                            these statistics regardless of orientation.
                        </p>
                    </div>
                </div> <!-- end modal-content div -->
            </div> <!-- end modal-dialog div -->
        </div> <!-- end modal div -->
    </body>
</html>

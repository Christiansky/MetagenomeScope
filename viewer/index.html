<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="shortcut icon" href="bubble.ico" />
        <meta name="viewport"
            content="width=device-width,initial-scale=1,user-scalable=no" />
        <title>AsmViz Viewer</title>
        <!-- Load external libraries:
             -Cytoscape.js (for drawing the graph)
             -sql.js (for reading SQLite .db files)
             -jQuery (for supporting jQuery UI)
             -Bootstrap -->
        <!-- TODO, ensure we use the minified versions for release. Also use a
            customized version of Bootstrap that only supports what features we
            need -->
        <script src="https://code.jquery.com/jquery-3.1.0.min.js"
            integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="
            crossorigin="anonymous"></script>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/viewer_style.css">
        <script src='js/cytoscape.min.js'></script>
        <script src='js/cytoscape-cose-bilkent.js'></script>
        <!-- next two scripts are for the dagre layout -->
        <script
            src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.js">
        </script>
        <script src='js/cytoscape-dagre.js'></script>
        <script src='js/sql.js'></script>
        <script src='js/xdot2cy.js'></script>
        <script src='js/bootstrap.min.js'></script>
        <!-- Initialize some event bindings for the application -->
        <script>
            $(function() {
                $(window).on("beforeunload", closeDB);
                $("input[name=rotationRadio]").on("change", changeRotation);
                $("#hideEdgesCheckbox").on("change", toggleHEV);
                $("#useTexturesCheckbox").on("change", toggleUTV);
                // If we add any tooltips, use this line to initialize them
                //$("[data-toggle='tooltip']").tooltip();
            });
        </script>
    </head>
    <body>
        <!-- Absolutely positioned tools -->
        <div id="controlsToggler" onclick="toggleControls();" class="btn">
           <span class="glyphicon glyphicon-menu-hamburger"></span>
        </div>

        <!-- NOTE: For all Bootstrap buttons, we need to do two "layers"
             of disabling. Adding the disabled class to a button makes
             Bootstrap style the button to look disabled, but the button
             will still be usable. Adding the disabled="disabled" attribute
             makes the button actually disabled (i.e. not usable).
        
             To handle this properly, we use the enableButton and
             disableButton functions (defined in xdot2cy.js) to ensure
             buttons are always properly disabled/enabled.
        -->
        <button class='btn btn-default btn-sm disabled'
            onclick='fitGraph(false)' id="fitButton" disabled="disabled">
            <span class="glyphicon glyphicon-resize-full"></span>
        </button>

        <button class='btn btn-default btn-sm disabled'
            onclick='fitGraph(true)' id="fitSelectedButton"
            disabled="disabled">
            <span class="glyphicon glyphicon-resize-small"></span>
        </button>

        <div id="controls">
            <!-- TODO replace these headers with a nicer-looking system? -->
            <h4 style="margin-top: 26px;">File Selection</h4>
            <p>
            <button class='btn btn-default btn-sm' id="xmlFileselectButton"
                onclick="openFileSelectDialog();">
                <span class="glyphicon glyphicon-repeat"
                    aria-hidden="true"></span> &nbsp; Demo .db
            </button>
            <button class='btn btn-default btn-sm' id="fileselectButton"
                onclick="$('#fileselector').click();">
                <span class="glyphicon glyphicon-folder-open"
                    aria-hidden="true"></span> &nbsp; Choose .db file
            </button>
            <!-- For some reason, styling this with a "hiddenElement" CSS class
                doesn't work; I suspect it's due to the way browsers handle
                styling of file inputs. Anyway, this should work fine. -->
    	    <input type='file' id='fileselector'
                onchange='loadgraphfile();' style="display: none"/>

            <button class='btn btn-default btn-sm disabled'
                disabled="disabled"
                onclick='displayInfo();' id="infoButton">
                <span class="glyphicon glyphicon-info-sign"
                    aria-hidden="true"></span> &nbsp; Assembly info
            </button>
            </p>
            <div class="progress">
                <div class="progress-bar notransitions" role="progressbar"
                     aria-valuenow="0" aria-valuemin="0"
                     aria-valuemax="100" style="width: 0%;">
                    <span class="sr-only"></span>
                </div>
            </div>
            <div id='textStatus'>&nbsp;</div>
            <hr />

            <h4>Connected Components</h4>
    
            <p>
                <div class='input-group input-group-sm'>
                    <span class='input-group-btn'>
                        <button class='btn btn-default disabled'
                            disabled="disabled" onclick='decrCompRank();'
                            type="button" id="decrCompRankButton">
                            <span class="glyphicon glyphicon-minus"
                                aria-hidden="true"
                                aria-label="Decrement component size rank by 1">
                            </span>
                        </button>
                    </span>
                    <input type='text' class='form-control'
                        id="componentselector" value="1" min="1"
                        disabled="disabled">
                    <span class='input-group-btn'>
                        <button class='btn btn-default disabled'
                            disabled="disabled" onclick='incrCompRank();'
                            type="button" id="incrCompRankButton">
                            <span class="glyphicon glyphicon-plus"
                                aria-hidden="true"
                                aria-label="Increment component size rank by 1">
                            </span>
                        </button>
                    </span>
                </div>
                <button class='btn btn-default btn-sm disabled'
                    disabled="disabled" onclick='startDrawComponent();'
                    type="button" id="drawButton">
                    <span class="glyphicon glyphicon-pencil"
                        aria-hidden="true"></span> &nbsp;
                        Draw connected component
                </button>
            </p>
            <hr /> 

            <h4>Selected Elements</h4>
            <p>
    
            <!-- Selected node info -->
            <div class="selectedEleHeader"
                    onclick="toggleEleInfo('node');">
                Nodes <span class="badge" id="selectedNodeBadge">0</span>
                <span class="glyphicon glyphicon-triangle-right opener"
                    id="nodeOpener"></span>
            </div>
            <div id="nodeInfo" class="notviewable">
                <table border="2" id="nodeInfoTable" class="infoTable">
                    <tr>
                        <th colspan='5' id="nodeTH">
                            Selected Node Information</th>
                    </tr>
                    <tr>
                        <th>ID</th>
                        <th id="labelCol">Label</th>
                        <th>Length</th>
                        <th id="depthCol">Depth</th>
                        <th id="gcContentCol">G/C Content</th>
                    </tr>
                </table>
            </div>
            <!-- Selected edge info -->
            <div class="selectedEleHeader"
                    onclick="toggleEleInfo('edge');">
                Edges <span class="badge" id="selectedEdgeBadge">0</span>
                <span class="glyphicon glyphicon-triangle-right opener"
                    id="edgeOpener"></span>
            </div>
            <div id="edgeInfo" class="notviewable">
                <table border="2" id="edgeInfoTable" class="infoTable">
                <tr>
                    <th colspan='6' id="edgeTH">Selected Edge Information</th>
                </tr>
                <tr>
                    <th>Src ID</th>
                    <th>Tgt ID</th>
                    <th id="multiplicityCol">Mult</th>
                    <th id="orientationCol">Orient</th>
                    <th id="meanCol">Mean</th>
                    <th id="stdevCol">Std. Dev</th>
                </tr>
                </table>
            </div>
            <!-- Selected cluster info -->
            <div class="selectedEleHeader"
                    onclick="toggleEleInfo('cluster');">
                Clusters <span class="badge" id="selectedClusterBadge">0</span>
                <span class="glyphicon glyphicon-triangle-right opener"
                    id="clusterOpener"></span>
            </div>
            <div id="clusterInfo" class="notviewable">
                <table border="2" id="clusterInfoTable" class="infoTable">
                <tr>
                    <th colspan='2'>Selected Cluster Information</th>
                </tr>
                <tr>
                    <th>Cluster Type</th>
                    <th>Node Count</th>
                </tr>
                </table>
            </div>

            </p>
            <hr /> 

            <h4>Search for Elements</h4>
            <div class='input-group input-group-sm'>
                <input type='text' class='form-control'
                    placeholder="Element ID/Node Label(s)" id="searchInput"
                    disabled="disabled" onkeypress="searchWithEnter(event);">
                <span class='input-group-btn'>
                    <button class='btn btn-default disabled'
                        disabled="disabled"
                        onclick='searchForEles();' type="button"
                        id="searchButton" aria-label="Search">
                        <span class="glyphicon glyphicon-search"
                            aria-hidden="true"></span>
                    </button>
                </span>
            </div>
            
            <hr />
            <h4>Display Options</h4>
            <!--
            Graph Rotation
            <div class="btn-group" data-toggle="buttons"
                aria-label="Graph hierarchical rank direction"
                id="rotationButtonGroup">
                <button class="btn btn-default disabled btn-sm" value="0"
                    id="dir0" disabled="disabled">
                    <input type="radio" name="rotationRadio"
                        autocomplete="off">&#8595;
                </button>
                <button class="btn btn-default active disabled btn-sm"
                    value="90" id="dir90" disabled="disabled">
                    <input type="radio" name="rotationRadio" checked="checked"
                        autocomplete="off">&#8594;
                </button>
                <button class="btn btn-default disabled btn-sm" value="180"
                    id="dir180" disabled="disabled">
                    <input type="radio" name="rotationRadio"
                        autocomplete="off">&#8593;
                </button>
                <button class="btn btn-default disabled btn-sm" value="270"
                    id="dir270" disabled="disabled">
                    <input type="radio" name="rotationRadio"
                        autocomplete="off">&#8592;
                </button>
            </div>
            -->

            <p>
            <!-- Value of this button will be toggled as all nodes in graph
                 are collapsed/uncollapsed -->
            <button class='btn btn-default btn-sm disabled' disabled="disabled"
                id='collapseButton' onclick='startCollapseAll();'>
                <span id="collapseButtonIcon"
                    class="glyphicon glyphicon-minus-sign"></span> &nbsp;
                <span id="collapseButtonText">Collapse all node groups</span>
            </button>
            </p>

            <p>
            <button class='btn btn-default btn-sm disabled' disabled="disabled"
                id='reduceEdgesButton'
                onclick='reduceEdgesToStraightLines(true);'>
                <span class="glyphicon glyphicon-sort"></span> &nbsp;
                <span>Reduce all edges to straight lines</span>
            </button>
            </p>

            <div class='input-group input-group-sm'>
                <span class='input-group-btn'>
                    <button class='btn btn-default disabled'
                        disabled="disabled" onclick='cullEdges();'
                        type="button" id="cullEdgesButton">
                        <span class="glyphicon glyphicon-remove"
                            aria-hidden="true"></span> &nbsp;
                        Hide edges below a weight of
                    </button>
                </span>
                <input type='text' class='form-control'
                    id="cullEdgesInput" value="0" disabled="disabled">
            </div>

            <hr />
            <h4>Node Colorization</h4>
            <p>
            <div class="btn-group" data-toggle="buttons"
                id="nodeColorizationButtonGroup"
                aria-label="Node colorization selector">
                <button class="btn btn-default active disabled btn-sm"
                    value="none" id="noNodeColorizationOption"
                    disabled="disabled">
                    <input type="radio" name="nodeColorization"
                        id="noNodeColorization" autocomplete="off">None
                </button>
                <button class="btn btn-default disabled btn-sm" value="gc"
                    id="gcNodeColorizationOption" disabled="disabled">
                    <input type="radio" name="nodeColorization"
                        id="gcNodeColorization"
                        autocomplete="off">G/C content
                </button>
            </div>

            <button class='btn btn-default btn-sm disabled'
                disabled="disabled" id='changeNodeColorizationButton'
                onclick='startChangeNodeColorization();'>
                <span class="glyphicon glyphicon-check"></span> &nbsp; Apply
            </button>
            </p>

            <hr />
            <h4>View Scaffolds</h4>

            <button class='btn btn-default btn-sm disabled'
                id="scaffoldFileselectButton" disabled="disabled"
                onclick="$('#scaffoldFileSelector').click();">
                <span class="glyphicon glyphicon-folder-open"
                    aria-hidden="true"></span> &nbsp; Choose AGP file
            </button>
    	    <input type='file' id='scaffoldFileSelector'
                onchange='beginLoadAGPfile();' style="display: none"/>
            
            <p id="agpLoadedFileName" class="notviewable monospace"></p>
            <p id="scaffoldInfoHeader" class="notviewable"></p>
            
            <ul class="list-group" id="scaffoldListGroup">
            </ul>

            <hr />
            <h4>Assembly Finishing</h4>

            <button class='btn btn-success btn-sm disabled'
                id="startFinishingButton" disabled="disabled"
                onclick="startFinishing();">
                <span class="glyphicon glyphicon-play"
                    aria-hidden="true"></span> &nbsp; Start
            </button>

            <button class='btn btn-danger btn-sm disabled'
                id="endFinishingButton" disabled="disabled"
                onclick="endFinishing();">
                <span class="glyphicon glyphicon-stop"
                    aria-hidden="true"></span> &nbsp; End
            </button>

            <button class='btn btn-info btn-sm disabled'
                id="exportPathButton" disabled="disabled"
                onclick="exportPath();">
                <span class="glyphicon glyphicon-download-alt"
                    aria-hidden="true"></span> &nbsp; Export Path
            </button>

            <p id="assembledNodes"></p>

            <hr />
            <h4>Test Layouts</h4>
            <p>
            See <a class="actuallyalink" target="_blank"
            href="http://js.cytoscape.org/#layouts">here</a> for a
            list of predefined layouts.
            The <span class="monospace">cose-bilkent</span> and
            <span class="monospace">dagre</span> layout extensions are also
            available. Note that some of these layouts might take a
            while to run, and might look a bit strange; consider
            collapsing all node groups before running.
            <div class='input-group input-group-sm'>
                <input type='text' class='form-control'
                    placeholder="Layout name" id="layoutInput"
                    disabled="disabled" onkeypress="layoutWithEnter(event);">
                <span class='input-group-btn'>
                    <button class='btn btn-default disabled'
                        disabled="disabled"
                        onclick='testLayout();'
                        type="button" id="layoutButton" aria-label="Layout">
                        <span class="glyphicon glyphicon-arrow-right"
                            aria-hidden="true"></span>
                    </button>
                </span>
            </div>
            </p>

            <hr />
            <h4>Performance Options</h4>
            <p id="performanceOptionsInfo">
                Changes to these settings will take effect upon drawing a
                graph.
            </p>
            <div class="checkbox">
                <label>
                    <input type="checkbox" id="hideEdgesCheckbox"
                        disabled="disabled">
                    Hide edges during movement
                </label>
            </div>
            <div class="checkbox">
                <label>
                    <input type="checkbox" id="useTexturesCheckbox"
                        disabled="disabled">
                    Use a texture during movement
                </label>
            </div>

            <hr />
            <h4>Export Graph View</h4>
            <p>
            <div class="btn-group" data-toggle="buttons"
                id="imgTypeButtonGroup"
                aria-label="Image type (PNG vs. JPG) selector">
                <button class="btn btn-default active disabled btn-sm"
                    value="PNG" id="pngOption" disabled="disabled">
                    <input type="radio" name="imgTypeRadio" checked="checked"
                        autocomplete="off">PNG
                </button>
                <button class="btn btn-default disabled btn-sm" value="JPG"
                    id="jpgOption" disabled="disabled">
                    <input type="radio" name="imgTypeRadio"
                        autocomplete="off">JPG
                </button>
            </div>

            <button class='btn btn-default btn-sm disabled'
                disabled="disabled"
                id='exportImageButton' onclick='exportGraphView();'>
                <span class="glyphicon glyphicon-picture"></span> &nbsp;
                Export
            </button>
            </p>

            <div id='status'></div>
        </div> <!-- end controls div -->
        <div id="cy" class="nosubsume"></div> <!--container for Cytoscape.js-->
        <!-- XHR .db loader dialog -->
        <div class="modal fade" role="dialog" id='fsDialog'>
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close"
                            data-dismiss="modal" aria-label="Close dialog">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">
                            Select a demo assembly file
                        </h4>
                    </div> <!-- end modal-header div -->
                    <div class="modal-body">
                        <!-- modal-body stuff -->
                        <label for="ecoli.db">
                            E. coli (LastGraph [Velvet], 279 contigs,
                            332 edges)
                        </label>
                        <input type="radio" name="fs" id="ecoli.db"
                            checked="checked">
                        <br />
                        <label for="shakya.db">64-genome bacterial/archaeal
                            metagenome
                            from <a target="_blank"
                            href="http://www.ncbi.nlm.nih.gov/pubmed/23387867">
                                <em>Shakya et al.</em> 2013</a>
                            (GML [Bambus 3], 21,950 nodes, 23,501 edges)
                        </label>
                        <input type="radio" name="fs" id="shakya.db">
                        <br />
                        <label for="shakya_new.db">
                            <a target="_blank"
                            href="http://www.ncbi.nlm.nih.gov/pubmed/23387867">
                            <em>Shakya et al.</em></a> metagenome, simplified
                            (GML [Bambus 3], 379 nodes, 229 edges)
                        </label>
                        <input type="radio" name="fs" id="shakya_new.db">
                        <br />
                        <label for="20170220.db">oriented.gml (Feb. 20, 2017)
                            (GML [Bambus 3], 4100 nodes, 4983 edges)
                        </label>
                        <input type="radio" name="fs" id="20170220.db">
                        <br />
                        <label for="biofilm_judson.db">oriented_judson.gml
                            (GML [Bambus 3], 28,107 nodes, 23,405 edges)
                        </label>
                        <input type="radio" name="fs" id="biofilm_judson.db">
                        <br />
                        <label for="biofilm_judson2.db">oriented_judson_2.gml
                            (GML [Bambus 3], 1,839 nodes, 530 edges)
                        </label>
                        <input type="radio" name="fs" id="biofilm_judson2.db">
                        <br />
                        <label for="small_ecoli.db">E. coli (GML [Bambus 3],
                            168 nodes, 478 edges)
                        </label>
                        <input type="radio" name="fs" id="small_ecoli.db">
                        <br />
                        <label for="sample_salmonella.db">Salmonella enterica
                            (LastGraph, 61 contigs, 82 edges)
                        </label>
                        <input type="radio" name="fs" id="sample_salmonella.db">
                        <br />
                        <label for="sample_gfa.db">sample.gfa from <a
                               target="_blank"
                               href="https://github.com/sjackman/assembly-graph/blob/master/sample.gfa">Shaun Jackman</a>
                                (GFA, 6 contigs, 4 edges)
                        </label>
                        <input type="radio" name="fs" id="sample_gfa.db">
                        <br />
                        <label for="loop_gfa.db">loop.gfa from <a
                               target="_blank"
                               href="https://github.com/sjackman/assembly-graph/blob/master/loop.gfa">Shaun Jackman</a>
                                (GFA, 4 contigs, 4 edges)
                        </label>
                        <input type="radio" name="fs" id="loop_gfa.db">
                        <br />
                        <label for="longtest.db">Test graph for "long"
                            structural patterns
                            (LastGraph, 36 contigs, 36 edges)
                        </label>
                        <input type="radio" name="fs" id="longtest.db">
                    </div> <!-- end modal-body div -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default"
                            data-dismiss="modal">Close
                        </button>
                        <button type="button" class="btn btn-primary"
                            id="loadDBbutton" onclick="loadajaxDB();">
                            Load selected file
                        </button>
                    </div>
                </div> <!-- end modal-content div -->
            </div> <!-- end modal-dialog div -->
        </div> <!-- end modal div -->
        <!-- Assembly info dialog -->
        <div class="modal fade" tabindex="-1" role="dialog" id='infoDialog'>
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close"
                            data-dismiss="modal" aria-label="Close dialog">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">
                            Assembly information
                        </h4>
                    </div> <!-- end modal-header div -->
                    <div class="modal-body">
                        <table border="2" class="infoTable">
                            <tr>
                                <th>Filename</th>
                                <th>Filetype</th>
                                <th>Node Count</th>
                                <th>Total Node Length</th>
                                <th>Edge Count</th>
                                <th>Connected Component Count</th>
                                <th>N50</th>
                                <th id="asmGCTH">Assembly G/C Content</th>
                            </tr>
                            <tr>
                                <td id="filenameEntry"></td>
                                <td id="filetypeEntry"></td>
                                <td id="nodeCtEntry"></td>
                                <td id="totalBPLengthEntry"></td>
                                <td id="edgeCountEntry"></td>
                                <td id="connCmpCtEntry"></td>
                                <td id="n50Entry"></td>
                                <td id="asmGCEntry"></td>
                            </tr>
                        </table>
                        <p id="currComponentInfo">
                            No connected component has been drawn yet.
                        </p>
                        <h3>For contig assembly graphs (LastGraph, GFA)</h3>
                        <p>
                            The <strong>node count</strong> and
                            <strong>edge count</strong> fields in the table
                            above (not in the percentage statistics) only
                            include "positive" contigs and their edges from
                            the assembly graph. If you would like to know
                            these statistics with negative nodes included,
                            then you can just multiply these fields by two.
                        </p>
                        <h3>For scaffolded assembly graphs
                            (GML [Bambus 3])</h3>
                        <p>
                            All nodes are included in
                            these statistics regardless of orientation.
                        </p>
                    </div>
                </div> <!-- end modal-content div -->
            </div> <!-- end modal-dialog div -->
        </div> <!-- end modal div -->
    </body>
</html>

language: python
python:
    - "3.6"
# Get stuff ready for testing SPQR functionality.
# NOTE I ran into troubles with building the most recent snapshot of OGDF, so
# I'm just using the stable release at present.
before_install:
    - rm metagenomescope/spqr
    - wget -O ogdf.zip https://ogdf.uos.de/wp-content/uploads/2019/04/ogdf.v2015.05.zip
install:
    # CODELINK: conda installation instructions per https://conda.io/docs/user-guide/tasks/use-conda-with-travis-ci.html
    - wget -O miniconda.sh https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
    - bash miniconda.sh -b -p $HOME/miniconda
    - export PATH="$HOME/miniconda/bin:$PATH"
    - hash -r
    - conda config --set always_yes yes --set changeps1 no
    - conda update -q conda
    - travis_retry conda create -q -c anaconda -n mgsc python=3.6 graphviz=2.38.0 pygraphviz numpy
    - pip install -e .[dev]
    - unzip ogdf.zip
    - cd OGDF
    # Install OGDF
    # (As of writing, the Travis CI virtual environments all have two cores.
    # So we parallelize the make operation to at most two jobs at once.)
    - bash makeMakefile.sh
    - make -j 2
    # At this point, OGDF has been installed. Now we can build the SPQR script.
    - cd ..
    - make spqr IDIR=OGDF/include/ RDIR=OGDF/_release/
    # We also install mocha-headless-chrome so that we can run the viewer
    # interface tests.
    - npm install -g mocha-headless-chrome
script:
    - source activate mgsc
    # This runs both the preprocessing script and viewer interface tests
    - make test
    # TODO: run make stylecheck here
after_success:
    # This section based on Qurro's Makefile. Upload coverage info to Codecov.
    - wget -O codecov.sh https://codecov.io/bash
    - bash codecov.sh -c

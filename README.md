# AsmViz

(That's the tentative name for this, at least.)

An interactive visualization tool for sequence assembly graphs. The goal
of this, as compared with other visualization tools, is to show the
pertinent parts of a graph instead of just displaying the entire graph at once.

To this end, AsmViz highlights certain patterns of contigs in the graph
(bubbles, frayed ropes, chains, and "linear" cycles), splits graphs up by
connected components, and uses [Graphviz](http://www.graphviz.org/)' `dot` tool
to hierarchically lay out each connected component of an assembly graph.

AsmViz is composed of two main components:

1. `collate.py`, a Python script that reads an assembly graph file,
   identifies patterns in it, separates it by connected components, and
   runs Graphviz on each component to be laid out, generating a SQLite
   .db file containing layout, pattern, and biological information extracted
   from Graphviz and from the original assembly graph file.
   Currently, this supports LastGraph (Velvet), GML
   (Bambus 3 scaffolds), and GFA assembly graph files, and support for GFA2
   and FASTG (SPAdes) files is planned. Please note that, although
   GFA files only have DNA sequences as an optional requirement
   (it's possible to denote the DNA of a sequence with just an asterisk),
   including DNA sequences in GFA files is currently required.

2. `viewer.html`, a HTML/Javascript webpage that reads a .db file
   generated by `collate.py` and renders the resulting graph in
   [Cytoscape.js](http://js.cytoscape.org/). This is coupled with an
   interface and "control panel" in which the graph can be searched,
   zoomed, panned, rotated, and fitted to the screen, nodes can be selected,
   and pattern-indicating groups of nodes can be collapsed (either on
   the level of individual nodes or for all node groups in the graph). The
   split nature of `collate.py` and `viewer.html` here allows the
   user greater latitude:
    - The user can save the layout/pattern information in a .db file and
      view it at a later time, without incurring the layout and
      patttern detection costs twice
    - The user can host `viewer.html` and a number of .db files on
      their server, allowing many users to view the assembly graphs without
      of the costs associated with layout and structural pattern detection

## System Requirements

### collate.py

* Python 2.7, with [PyGraphviz](https://pygraphviz.github.io/) and the
  following standard library modules installed:
    * [argparse](https://docs.python.org/2/library/argparse.html)
    * [sys](https://docs.python.org/2/library/sys.html)
    * [stat](https://docs.python.org/2/library/stat.html)
    * [subprocess](https://docs.python.org/2/library/subprocess.html)
    * [os](https://docs.python.org/2/library/os.html)
    * [errno](https://docs.python.org/2/library/errno.html)
    * [math](https://docs.python.org/2/library/math.html)
    * [sqlite3](https://docs.python.org/2/library/sqlite3.html)
* Graphviz (with the `dot` and `sfdp` layout programs installed)

### viewer.html

* Any modern internet browser (smartphone/tablet mobile browsers should
  work, also) supported by Cytoscape.js

## Running collate.py

`collate.py` is located in the graph\_collator folder. It can be
run from the command line;
see the [system requirements](#system-requirements) section above
for information on what other software needs to be installed.

Running `collate.py` will process an assembly graph file so that
it can be visualized. The syntax for this is

`./collate.py [-h] -i INPUTFILE -o OUTPUTPREFIX [-d OUTPUTDIRECTORY] [-pg]
    [-px] [-w] [-nodna] [-b BICOMPONENTSFILE]`

### Script output

The script will always produce a `.db` file that can be loaded in the viewer
application to visualize the assembly graph.

If the `-pg` argument is passed, `.gv` files (in the DOT language)
for each connected component of the assembly graph will be generated; if the
`-px` argument is passed, `.xdot` files (in the xdot language) for each
connected component of the assembly graph will be generated.

The script will also generate a few types of auxiliary files containing various
information about the structure of the assembly graph. These files are:

* `prefix_links`, where `prefix` is the output prefix passed via `-o`. Only one
  of these files will be generated per execution of `collate.py`. This file
  indicates all the edges in the assembly graph. If you pass in `-b` and the
  input assembly graph has unoriented contigs, then this file will not be
  generated (since it would be equivalent to the _single_links file in that
  case).
* `prefix_single_links`, where `prefix` is the output prefix passed via `-o`.
  This file will only be generated if the input assembly graph has unoriented
  contigs. In terms of currently supported input filetypes, this means that
  this file will only be generated when the input assembly graph is of type
  LastGraph or GFA.
* `prefix_bicmps`, where `prefix` is the output prefix passed via `-o`. Only
  one of these files will be generated per execution of `collate.py`. This
  file indicates the various separation pairs contained within the assembly
  graph (see [Nijkamp et al.](https://www.ncbi.nlm.nih.gov/pubmed/24058058)
  for a brief overview of separation pairs and their usage in bubble
  detection). It's possible to pass an existing version of this file using `-b`
  to the script, to prevent having to do the work of creating the file again.
* `component_D.info`, where `D` is an integer greater than 0. There will be one
  of these files created for every biconnected component contained within the
  assembly graph: these files indicate the contents of the SPQR tree defined
  for their corresponding biconnected component.
* `spqrD.gml`, where `D` is an integer greater than 0. These files correspond
  to `component_D.info` files: they indicate the connections between the
  metanodes of a SPQR tree.

The script requires all `component_D.info` and `spqrD.gml` files to be
removed from the output directory before it generates more of them.
If `-w` is enabled, then all existing files with corresponding names in the
output directory will be deleted; however, if `-w` is not enabled, then an
error will be raised.

Similarly, if files exist in the output directory with filenames overlapping 
those of the `prefix_links` and `prefix_bicmps` files, then those files will be
either deleted (if `-w` is enabled) or an error will be raised (if `-w` is not
enabled).

### Command-line argument descriptions

* `-i` The input assembly graph file to be used.
* `-o` The file prefix to be used for all files generated. As an example, given
  the argument
  `-o prefix`, the file `prefix.db` would be generated. If .gv and/or .xdot
  files are created (depending on the `-pg` or `-px` arguments, respectively),
  then those files will be numbered according to the relative size rank
  (in nodes) of their respective connected component within the assembly graph.
* `-d` This optional argument specifies the name of the directory in which
  all output files will be stored. If this argument is not indicated, then all
  files will be generated in the current working directory.
* `-nodna` This optional argument, if given, does not store the DNA
  sequences from assembly graph files in the output .db file. This
  option can help save a large amount of space in .db files, making
  processing them in AsmViz viewer faster.
* `-pg` This optional argument produces DOT files (suffix .gv) in the output
  directory. As an example, given the arguments `-o prefix` and `-pg` for an
  assembly graph with 3 connected components, the files `prefix.db`,
  `prefix_1.gv`, `prefix_2.gv`, and `prefix_3.gv` would be created (where
  `prefix_1.gv` indicates the largest connected component by number of nodes,
  `prefix_2.gv` indicates the next largest connected component, and so on).
* `-px` This optional argument produces .xdot files in the output
  directory. These files are labelled in an identical fashion to `.gv` files,
  with the only difference in naming being the file suffix (.xdot instead of
  .gv).
* `-b` This optional argument lets you pass in an existing file indicating the
  separation pairs in the graph (to be used in the detection of complex
  bubbles) to the script.
* `-w` This optional argument allows the overwriting of output files
  (.db/.xdot/.gv/links/single_links/bicmps/.info/spqr.gml files).
  If this argument is **not** given, then:
    * An error will be raised if writing a .db file would cause another
      .db file to be overwritten.
    * A warning will be displayed if writing to a .gv or .xdot file would cause
      another .gv/.xdot file to be overwritten. In this case, the .gv/.xdot
      file in question simply would not be saved.
    * Note that the presence of files in the
      output directory that are conflicting-named folders (e.g. a
      directory named `e_coli.db/` in the output directory while attempting to
      produce a file named `e_coli.db`) will cause an error/warning to be
      raised regardless of whether or not `-w` is set.

## Running viewer.html

_NOTE -- due to a restructuring of the viewer user interface, this section is
fairly out of date, sorry. I'll rewrite it when we're done or close to being
done with the viewer UI; in the interim, if you have any questions about the
viewer, please feel free to email me at mfedarko@umd.edu._

Open `viewer/viewer.html` in your favorite browser. Click
the "Choose File" button in the top-left corner of the screen and select
a database file generated by `collate.py` -- in the online demo, this is
done through a dialog of hosted .db files, and in the local demo, this is
done through a file upload of a .db file.

After that, the progress bar will change to indicate that the .db file is
being processed. Once the "Draw connected component," "Assembly info,"
and component selector elements are enabled (when they turn from gray to
white and become clickable), you can:

* Use the "Assembly info" button to view information about the .db file's
  assembly, if desired.
* Select a connected component to draw with the component selector. The
  range of acceptable values goes from 1 to the number of connected
  components in the assembly graph (which may also be 1), where 1 denotes
  the largest connected component in the assembly and smaller values indicate
  smaller (or equally-sized) connected components.
* Use the "Draw connected component" button to draw the selected component.
  The progress bar will periodically update to indicate the current status
  of the drawing process.

Once the progress bar is completely filled and the remaining UI elements
(with the exception of the "Selected node/edge info" button; see below) are
enabled, the graph is ready to be interacted with! An overview of the
available features:

* You can **zoom in/out** on the graph by scrolling up/down.
* You can **pan** the graph by clicking on the screen (not on a node or edge)
  and dragging the mouse in accordance with the desired direction of
  movement.
* You can **drag** nodes/node groups by clicking on them and dragging them
  with your mouse.
* You can **view information about the assembly graph and currently drawn
  connected component** by using the "Assembly info" button.
* You can **draw another connected component** by repeating the process
  detailed above (selecting the "size rank" of the component to draw using
  the component selector, and then pressing the "Draw connected component"
  button).
* You can **select multiple nodes, edges, and node groups** by holding down
  the SHIFT or CTRL keys and clicking on the element in question, or by
  holding down the SHIFT or CTRL keys while clicking and dragging the mouse
  to select a group of nodes or edges. Selected
  nodes/node groups can be moved around by dragging them, but note that
  selected edges cannot be moved independently of their source/sink nodes.
* Selecting nodes/edges will cause the "Selected node/edge info" button to
  be enabled, which you can use to **view information about currently selected
  nodes and edges**. If one or more nodes are selected and all of the selected
  nodes have DNA sequence information available (i.e. the current assembly
  graph's nodes are contigs, and `-nodna` was not used in collate.py), then
  the node/edge information dialog will contain two buttons that can be used to
  either copy the DNA sequences of all selected nodes (in FASTA format)
  to the clipboard or to export the DNA sequences directly to a FASTA file.
* You can **search for nodes, edges, or node groups** using the "Search"
  button. Note that edge IDs are (currently) given as
  `node1->node2`, where `node1` is the name of the source node and `node2`
  is the name of the sink (target) node.
* You can **scale** the graph to fit within the current window size using
  the "Fit Graph" button. This is done by default after rendering the graph
  for the first time, and done by default after rotating the graph.
* You can **rotate** the graph so that its nodes are laid out in the general
  direction indicated by using the "Graph Rotation" selection list.
  Selecting a different rotation than the current one will cause the entire
  graph to be rotated in that direction, followed by the graph being scaled
  to optimally fit within the current window size. Note that this preserves
  the state of the graph, so any collapsed/uncollapsed node groups, selected
  elements, or other modified properties of the graph will remain across
  rotations.
* You can **collapse and uncollapse individual node groups** by
  right-clicking on them; however, note that you have to right-click on
  the node group itself to do this, not on any of the nodes/edges within
  the node group. Collapsing a node group will convert any incoming/outgoing
  edges to that node group to straight-line Bezier edges, since no Graphviz
  data exists defining such an edge.
* You can **collapse and uncollapse all node groups in the graph** by using
  the "Collapse All Node Groups"/"Uncollapse All Node Groups" button located
  near the top-right corner of the screen. Individually-collapsed node
  groups will be ignored upon collapsing all nodes, and already-uncollapsed
  node groups will be ignored upon uncollapsing all nodes.

## Acknowledgements: tools used

* `collate.py` uses Graphviz' dot and sfdp layout tools via the
  [PyGraphviz](http://pygraphviz.github.io/) interface.
* Both `collate.py` and the AsmViz viewer use [sqlite3](https://sqlite.org/).
  In particular, `collate.py` uses the aforementioned Python sqlite3 module
  while the AsmViz viewer uses [sql.js](https://github.com/kripken/sql.js/) to
  process .db files on the client side.
* The AsmViz viewer uses [Cytoscape.js](https://js.cytoscape.org/) to render
  graphs on the client side.
    * Also, the toggling protocol used for the control panel of the AsmViz
      viewer was inspired by a similar toggling mechanism used in
      [this Cytoscape.js
      demo](http://js.cytoscape.org/demos/2ebdc40f1c2540de6cf0/).
* The AsmViz viewer uses [jQuery](https://jquery.com/) and
  [Bootstrap](http://getbootstrap.com/) for various stylistic and functional
  purposes in the application.
    * The icons used to theme various controls in the viewer application are
      from the [Glyphicon](http://glyphicons.com/) Halflings set,
      included with Bootstrap.
